<link rel="import" href="./fsLoader.html">
<link rel="import" href="./gitHubGuideLoader.html">
<link rel="import" href="../../jquery.html">

<script>
  // TODO: Use configurable directory and destroy GBS_DIRNAME
  const guidesPath = `${window.GBS_DIRNAME}/guides`;
  const zipPath = `${window.GBS_DIRNAME}/guides.zip`;
  const contentPath = `${guidesPath}/content`;
  const jsonPath = `${contentPath}/guides.json`;

  class DesktopGuideLoader {
    constructor({ exercises }) {
      this.exercises = exercises;
    }

    static download(courseSlug, onProgress) {
      courseSlug = courseSlug || "gobstones/proyectos-jr";

      const repoName = _.last(courseSlug.split("/"));
      const url = `https://github.com/${courseSlug}/archive/master.zip`;

      const fs = window.GBS_REQUIRE("fs");
      const unzipper = new (window.GBS_REQUIRE("decompress-zip"))(zipPath);
      window.GBS_REQUIRE("setimmediate");

      const deferred = new $.Deferred();
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.responseType = "arraybuffer";
      xhr.onload = function () {
        if (this.status === 200) deferred.resolve(xhr.response);
        else deferred.reject({ status: this.status });
      };
      xhr.onprogress = function(e) {
        //if (e.lengthComputable) onProgress(e.loaded, e.total);
        onProgress(e.loaded);
      };
      xhr.send();

      return deferred.promise()
        .then((file) => {
          fs.writeFileSync(zipPath, new Buffer(file));

          try { fs.rmdirSync(guidesPath); } catch (e) { }
          try { fs.mkdirSync(guidesPath); } catch (e) { }

          const deferred = new $.Deferred();
          unzipper.on("error", (err) => {
            deferred.reject(err);
          });

          unzipper.on("extract", () => {
            deferred.resolve();
          });

          unzipper.extract({
            path: guidesPath
          });

          return deferred.promise();
        }).then((r) => {
          fs.renameSync(`${guidesPath}/${repoName}-master`, contentPath);
          return r;
        });
    }

    static all() {
      try {
        const json = window.GBS_REQUIRE("fs").readFileSync(
          jsonPath
        );
        const guides = JSON.parse(json);

        return promisify(guides);
      } catch(e) {
        console.warn(e);
        return promisify([]);
      }
    }

    static makeUrlFor(guide, exercise) {
      const path = `${contentPath}/${exercise.path}`;
      return `/${window.GBS_PROJECT_TYPE}?fs=${path}`;
    }

    getExercises() {
      return promisify(this.exercises.map((exercise) => {
        return _.assign(exercise, {
          imageUrl: this._makeImageUrl(exercise.path)
        });
      }));
    }

    _makeImageUrl(exercisePath) {
      try {
        const path = `${contentPath}/${exercisePath}`;

        const bitmap = window.GBS_REQUIRE("fs")
          .readFileSync(`${path}/cover.png`)
        const base64 = new Buffer(bitmap).toString("base64");
        return `data:image/png;base64,${base64}`;
      } catch(e) {
        console.warn(e);
        return null;
      }
    }
  }
</script>
