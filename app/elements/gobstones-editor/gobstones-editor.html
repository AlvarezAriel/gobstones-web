<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/ace-widget/ace-widget.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../scripts/stylist.html">

<dom-module id="gobstones-editor">
  <template>

    <style>
      :host {
        display: block;
        height: 100vh;
      }

      ace-widget {
        height: 100%;
        --ace-widget-editor: {
          font: var(--editor-size)/normal 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace !important;
          @apply(--gobstones-editor);
        }
      }

      .run-button {
        position: absolute;
        bottom: 30px;
        right: 24px;
      }
    </style>

    <iron-localstorage name="last-code" value="{{code}}"></iron-localstorage>
    <iron-localstorage name="font-size" value="{{fontSize}}" on-iron-localstorage-load-empty="_initializeDefaultFontSize"></iron-localstorage>

    <ace-widget
      id="ace"
      mode="ace/mode/gobstones"
      theme="ace/theme/chrome"
      font-size="5"
      tab-size="4"
      minlines="30"
      maxlines="30"
      initial-focus
    ></ace-widget>

    <code-runner class="run-button" id="runner"></code-runner>
  </template>

  <script>

    Polymer({
      is: "gobstones-editor",
      behaviors: [
        Polymer.LocalizationBehavior
      ],
      listeners: {
        "ace.editor-ready": "onAceReady",
        "ace.editor-content": "onContentChange",
        "iron-localstorage-load": "onLastCodeLoaded"
      },
      properties: {
        mode: { type: String, value: "main" },
        codeWasLoaded: { type: Boolean, value: false },
        code: {
          type: Object,
          observer: "_initializeCode"
        },
        fontSize: {
          type: Number,
          observer: "_fontSizeChanged"
        }
      },

      ready: function() {
        this.MIN_FONT_SIZE = 8;
        this.DEFAULT_FONT_SIZE = 17;
        this.HOP_SIZE = 3;

        this._subscribeToBoards("initial-state", (eventInfo) => {
          this._runCode(eventInfo.detail);
        });

        this.runner = this.$.runner;
        this.runner.addEventListener("run", () => {
          this._onRunRequest()
          this.editor.readonly = true;
        });
        this.runner.addEventListener("cancel", () => {
          this.fire("cancel-request");
          this.editor.readonly = false;
        });
        this.runner.addEventListener("end", () => {
          this.editor.readonly = false;
        });

        this.editor = this.$.ace.editor;
        this._setFatalities();

        this.stylist = new Stylist();
        this._removePrintMarginColumn();
        $(window).resize(() => { this._fixEditorHeight(); });
      },

      setCode: function(code, mode = "main") {
        this.code[mode] = code;
        if (this.mode === mode) this.editor.setValue(code);
      },

      onAceReady: function() {
        this.$.ace.editor.$blockScrolling = Infinity;
      },

      onContentChange: function(content) {
        this.set(`code.${this.mode}`, content.detail.value);
        this.setAsDirty();
      },

      onLastCodeLoaded: function() {
        if (this.codeWasLoaded) return;
        this.editor.setValue(this.code.main);
        this.codeWasLoaded = true;
      },

      increaseFontSize: function() {
        this.fontSize += this.HOP_SIZE;
      },

      decreaseFontSize: function() {
        this.fontSize -= this.HOP_SIZE;
      },

      toggleMode: function() {
        this._setMode(
          this.mode === "main" ? "library" : "main"
        );
      },

      setAsDirty: function() {
        this.editor.getSession().setAnnotations([]);
        this.fire("editor-dirty");
      },

      reset: function() {
        this._setMode("main");
        this.setCode("", "main");
        this.setCode("", "library");
      },

      _onRunRequest: function() {
        this._setMode("main");
        this.fire("run-request");
      },

      _initializeDefaultFontSize: function() {
        this.fontSize = this.DEFAULT_FONT_SIZE;
      },

      _fontSizeChanged: function(newValue, oldValue) {
        if (newValue <= this.MIN_FONT_SIZE) {
          this.fontSize = oldValue;
          return;
        }

        this.editor.setFontSize(newValue);
        setTimeout(() => { this._fixEditorHeight(); }, 500);
      },

      _runCode: function(initialState) {
        this.editor.getSession().clearAnnotations();

        const libraryAst = this.runner.parse(this.code.library);
        if (libraryAst && libraryAst.error)
          this._setMode("library");

        const sourceCode = this.code.library + "\n" + this.code.main;
        const options = { onlyCode: true };

        try {
          this.runner.run(
            { initialState, sourceCode, options },
            (state) => this._notify(state),
            (e) => {
              this._reportError(e, e.error, "error", options);
              this.fire("compilation-error", e.error);
            }
          );
        } catch (e) {
          this.fire("unknown-error", e);
          console.error("---UNKNOWN ERROR---");
          throw e;
        }
      },

      _notify: function(state) {
        const e = state.error;

        if (e) {
          this._reportError(e, e.message, "info", e.options);
          this.fire("execution-error", e.message);
        } else
          this.fire("execution-result", { board: state });
      },

      _reportError: function(e, message, type, options) {
        const line = this._getErrorLine(e, options);

        this.editor.getSession().setAnnotations([{
          row: line,
          column: 0,
          text: message,
          type: type
        }]);
      },

      _getErrorLine: function(e, options = {}) {
        const libraryLines = this.code.library.split("\n").length;

        try {
          return e.on.range.start.row - (options.onlyCode ? libraryLines : 0);
        } catch(unknownError) {
          throw e;
        }
      },

      _setMode: function(mode) {
        this.mode = mode;
        this.fire("mode-change", this.mode);
        this.editor.setValue(this.code[this.mode]);
        this.editor.focus();
      },

      _removePrintMarginColumn: function() {
        this.editor.setShowPrintMargin(false);
      },

      _subscribeToBoards: function(eventName, eventHandler) {
        this.async(() => {
          document.querySelector("#boards").addEventListener(eventName, eventHandler);
        });
      },

      _setFatalities: function() {
        const ace = this.$.ace;

        ace.editor.commands.addCommand({
          name: "run-code",
          bindKey: { win: "ctrl+enter", mac: "command+enter" },
          exec: () => { this.runner.requestRun() }
        });
      },

      _fixEditorHeight: function() {
        this.stylist.correctEditorHeight(this.editor);
      },

      _initializeCode: function() {
        if (!this.code) this.code = { main: "", library: "" };
      }
    });

  </script>
</dom-module>
