<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../scripts/parser.html">
<link rel="import" href="../../scripts/runners/normalRunner.html">
<link rel="import" href="../../scripts/runners/interactiveRunner.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/toastBehavior.html">

<dom-module id="code-runner">
  <style>
    .random-toggle {
      position: absolute;
      cursor: pointer;
      z-index: 99;
      left: 49px;
      top: 43px;
    }

    .speed-slider {
      width: 80px;
      transform: translateX(-14px);

      --paper-slider-knob-start-color: var(--google-blue-700);
      --paper-slider-knob-start-border-color: var(--google-blue-700);
      --paper-slider-pin-start-color: var(--google-blue-700);
    }

    .toast {
      --paper-toast-background-color: rgba(11, 70, 93, 0.8);
      margin-left: 53px !important;
    }
  </style>

  <template>
    <paper-toast class="toast" id="toast"></paper-toast>
    <gobstones-code-runner
      id="playButton"
      style="z-index: 10;"
      title="{{localize('execute')}}"
    ></gobstones-code-runner>
    <template is="dom-if" if="{{permissions.can_change_source}}">
      <paper-button class="random-toggle" on-click="toggleRandom"><iron-icon class$="{{toggleRandomCss(useRandomBoard)}}" icon="av:shuffle"></iron-icon></paper-button>
    </template>
    <paper-slider id="speedSlider" style="z-index: 10" class="speed-slider" snaps min="1" max="5" max-markers="5" step="1" value="{{speed}}" immediate-value="{{immediateSpeed}}" value="5", disabled="{{!permissions.can_change_speed}}"></paper-slider>
  </template>

  <script>
    const MAX_SPEED = 5;

    Polymer({
      is: 'code-runner',
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.LocalizationBehavior,
        Polymer.ToastBehavior
      ],
      properties: {
        speed: {
          type: Number,
          value: MAX_SPEED
        },
        useRandomBoard: {
          type: Boolean,
          value: false
        },

        throttle: {
          type: Number,
          computed: "_computeThrottle(speed)"
        },
        immediateSpeed: {
          type: Number,
          value: MAX_SPEED
        },

        permissions: {
          type: Object,
          value: {
            can_change_source: true,
            can_change_speed: true
          }
        }
      },
      listeners: {
        "immediate-value-change": "_onSpeedChange",
        "gbs-run-request": "_onRunRequest",
        "gbs-start": "_onStart",
        "gbs-stop": "_onStop"
      },

      ready: function() {
        this.parser = new Parser();
        this.runner = new NormalRunner(this.parser);
        this.subscribeTo("reset", () => this.reset());
      },

      run: function(request, onCompilationError, onResult) {
        debugger;
        const code = request.code;
        const itBroke = (err, code) => {
          this.stop();
          onCompilationError(err, code);
        };

        try {
          // TODO: CambiÃ© la interfaz, arreglar el llamado
          this._checkAndGetTeacherAst(code, itBroke, teacherAst => {
            this._parse(code, itBroke, ast => {
              this._setRunner(ast);
              if (!ast.program) {
                const error = new Error(this.localize("missing-program"));
                error.on = {};
                error.location = { mode: "code", line: 1 };
                itBroke(error);
                return;
              }

              this.runner.run({
                ast: {
                  program: ast.program,
                  teacher: teacherAst
                },
                request: request,
                throttle: this.throttle,
                callbacks: {
                  onResult: onResult,
                  onStop: (eventToFire) => this.stop(eventToFire),
                  onReturnValue: (value) => {
                    window.BUS.fire("return-value", { value });
                  }
                }
              });
            }, true);
          });
        } catch (e) {
          this.stop();
          throw e;
        }
      },

      requestRun: function() {
        this._clear();
        this.fire("run", { useRandomBoard: this.useRandomBoard });
      },

      stop: function(eventToFire = "cancel") {
        window.BUS.fire("execution-stop");
        this._clear();
        this.$.playButton.stop();
        this.async(() => {
          this.fire(eventToFire);
        });
      },

      toggleRandom: function() {
        this.useRandomBoard = !this.useRandomBoard;
        this.showToast(this.localize(`using-random-${this.useRandomBoard}`));
      },

      reset: function() {
        this.speed = MAX_SPEED;
        this.useRandomBoard = false;

        this.set("permissions.can_change_source", true);
        this.set("permissions.can_change_speed", true);
      },

      reportTeacherLibraryErrors: function(e) {
        this.showToast(this.localize("teachers-library-has-errors"));
        throw e;
      },

      _onRunRequest: function({ detail: { start, stop } }) {
        // this.requestRun();
        start({ initialBoard: 1, code: 2, targetBoard: 3 }); // TODO: Hacer
      },

      _onStart: function() {
        window.GBS_IS_RUNNING = true;
      },

      _onStop: function({ detail: reason }) {
        window.GBS_IS_RUNNING = false;
      },

      _onSpeedChange: function() {
        this.showToast(this.localize(`speed-${this.immediateSpeed}`));
      },

      _computeThrottle: function(speed) {
        if (this.speed === 5) return 0;
        if (this.speed === 4) return 50;

        return -(this.speed - 4) * 300;
      },

      toggleRandomCss: function(useRandomBoard) {
        return useRandomBoard ? "blue-sky" : "gray"
      }
    });
  </script>
</dom-module>
