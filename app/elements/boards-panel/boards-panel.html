<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../bower_components/gs-board/dist/components/gs-board.html">
<link rel="import" href="../../scripts/parserAndBoardAdapter.html">

<dom-module id="boards-panel">
  <template>

    <style>
      .boards-panel {
        text-align: center;
      }

      .wind-rose {
        position: absolute;
        z-index: 99;
        opacity: 0.5;
        top: 0;
        right: 0;
        margin: 5px;
      }

      .initial-board {
        margin-bottom: 20px;
      }

      .alert {
        color: red;
      }

      .toast {
        --paper-toast-background-color: #607d8b;
      }
    </style>

    <paper-toast class="toast" id="toast" horizontal-align="left"></paper-toast>

    <img class="wind-rose" src="../../images/wind-rose.png" />
    <div class="boards-panel">
      <div class="initial-board">
        <div>Tablero inicial:</div>
        <gs-board id="initialStateEditor" size='{ "x": 4, "y": 4 }' options='{ "editable": true }' cell-size="60" min-width="147" min-height="146"></gs-board>
      </div>

      <template is="dom-if" if="{{error}}">
        <div>
          <img src="../../images/boom.png" />
          <h2>BOOM</h1>
          <div class="alert">{{error}}</div>
        </div>
      </template>

      <template is="dom-if" if="{{!error}}">
        <template is="dom-if" if="{{finalState}}" restamp="true">
          <div>
            <div>Tablero final (resultado):</div>
            <gs-board table='{{finalState.table}}' header="{{finalState.header}}"></gs-board>
          </div>
        </template>
      </template>

    </div>

  </template>

  <script>

    Polymer({
      is: 'boards-panel',
      properties: {
        finalState: Object,
        error: Object
      },

      ready: function() {
        this._adapter = new ParserAndBoardAdapter();

        this._subscribeToEditor("execution-request", () => {
          this._onRunRequest();
        });

        this._subscribeToEditor("execution-result", (eventInfo) => {
          this._onResult(eventInfo);
        })._subscribeToEditor("compilation-error", (eventInfo) => {
          this._onCompilationError(eventInfo);
        })._subscribeToEditor("execution-error", (eventInfo) => {
          this._onExecutionError(eventInfo);
        });
      },

      _onRunRequest: function() {
        this._clean();

        const initialStateEditor = this.$.initialStateEditor;
        const initialState = {
          header: initialStateEditor.header,
          table: this._adapter.adaptToParser(initialStateEditor.table),
          size: initialStateEditor.size
        }
        this.fire("initial-state", initialState);
      },

      _onResult: function(result) {
        const board = result.context.board();

        this._setFinalState({
          header: _.pick(board, "x", "y"),
          table: this._adapter.adaptToBoard(board.table)
        });
      },

      _onCompilationError: function(error) {
        this._showToast("El programa tiene errores");
      },

      _onExecutionError: function(error) {
        this.error = error;
      },

      _setFinalState: function(finalState) {
        this.finalState = null;
        this.async(function() {
          this.finalState = finalState;
        });
      },

      _clean: function() {
        this.finalState = null;
        this.error = null;
      },

      _showToast: function(message) {
        this.$.toast.text = message;
        this.$.toast.opened = true;
      },

      _subscribeToEditor: function(eventName, eventHandler) {
        const handler = (event) => eventHandler(event.detail);
        this.async(() => {
          document.querySelector("#editor").addEventListener(eventName, handler);
        });
        return this;
      }

    });

  </script>
</dom-module>
