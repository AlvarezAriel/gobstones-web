<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/gs-board/dist/components/gs-board.html">

<dom-module id="boards-panel">
  <template>
    <div>
      Tablero inicial
    </div>
    <gs-board size='{ "x": 4, "y": 4 }' options='{ "editable": true }'></gs-board>

    <template is="dom-if" if="{{finalState}}">
      <div>
        Tablero final (resultado)
      </div>
      <gs-board header="{{finalState.header}}" board='{{finalState.board}}'></gs-board>
    </template>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'boards-panel',
        properties: {
          finalState: Object
        },
        ready: function() {
          var self = this;
          this.async(function() {
            document.querySelector("#ide").addEventListener("execution-result", function(eventInfo) {
              self.onExecute(eventInfo.detail);
            })
          })
        },

        onExecute: function(event) {
          var board = event.context.board();
          var header = _.pick(board, "x", "y");
          var adaptedTable = this._adaptTableFromCompilerToBoard(board.table);

          this._setFinalState({
            header: header,
            board: adaptedTable
          });
        },

        _adaptTableFromCompilerToBoard: function(table) {
          // TODO: Mover a alg√∫n adapter
          table = table.map(function(colorRows) {
            return colorRows.reverse();
          });

          var mapColor = function(index, color) {
            return table[index].map(function(row) {
              return row.map(function(amount) {
                var cell = {};
                cell[color] = amount;
                return cell;
              });
            });
          }

          var blueRows = mapColor(0, "blue");
          var redRows = mapColor(1, "red");
          var blackRows = mapColor(2, "black");
          var greenRows = mapColor(3, "green");

          return _.zipWith(blueRows, redRows, blackRows, greenRows, function(blue, red, black, green) {
            return _.merge(blue, red, black, green);
          });
        },

        _setFinalState: function(finalState) {
          this.finalState = null;
          this.async(function() {
            this.finalState = finalState;
          });
        }
      });

    })();
  </script>
</dom-module>
