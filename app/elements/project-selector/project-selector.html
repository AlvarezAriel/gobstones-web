<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/loaders/remote/gitHubGuideLoader.html">
<link rel="import" href="../../scripts/loaders/remote/desktopGuideLoader.html">

<dom-module id="project-selector">
  <style>
    .exercise {
      cursor: pointer;
      width: 200px;
      height: 200px;
      float: left;
      margin: 20px;
    }

    .no-exercises {
      margin-top: 40px;
    }
  </style>

  <template>
    <h1>[[localize("select-an-exercise")]] <paper-icon-button suffix icon="folder-open" on-click="loadFromFile"></paper-icon-button></h1>

    <paper-dropdown-menu no-animations no-label-float vertical-align="bottom" horizontal-align="right">
      <paper-listbox class="dropdown-content" selected="{{selectedGuide}}">
        <template is="dom-repeat" items="{{ guides }}">
          <paper-item>{{item.name}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

    <div class="container">
      <template is="dom-repeat" items="[[exercises]]">
        <div class="exercise">
          <a on-tap="goToExercise">
            <h3>[[item.name]]</h3>
            <img width="150px" height="150px" src="{{item.imageUrl}}" />
          </a>
        </div>
      </template>
      <template is="dom-if" if="[[_isEmpty(exercises)]]">
        <h3 class="no-exercises">
          [[localize("no-exercises")]]
        </h3>
      </template>
    </div>
  </template>

  <script>

    Polymer({
      is: 'project-selector',
      behaviors: [
        Polymer.LocalizationBehavior
      ],
      properties: {
        guides: {
          type: Array,
          value: []
        },
        guide: {
          type: Object,
          computed: "_computeGuide(selectedGuide)",
          observer: "_onGuideChange"
        },
        selectedGuide: {
          type: Number,
          value: -1
        }
      },

      ready: function() {
        this._startLoading();
        this._guideLoader().all().then((guides) => {
          this.guides = guides;
          this.selectedGuide = localStorage.getItem("selected-guide") || 0;
        }).catch(() => this._stopLoading());
      },

      goToExercise: function(event) {
        this._ide().hideProjectSelectorModal();

        const exercise = event.model.item;

        this._goTo(
          this._guideLoader().makeUrlFor(this.guide, exercise)
        );
      },

      loadFromFile: function() {
        window.BUS.fire("load-project-from-file");
      },

      _loadCurrentGuide: function() {
        const TheGuideLoader = this._guideLoader();
        new TheGuideLoader(this.guide).getExercises().then(exercises => {
          this.exercises = exercises;
          this._resizePopup();
        }).always(() => {
          this._stopLoading();
        });
      },

      _computeGuide: function(selectedGuide) {
        return this.guides[selectedGuide];
      },

      _onGuideChange: function() {
        localStorage.setItem("selected-guide", this.selectedGuide);
        this._startLoading();
        this._loadCurrentGuide();
      },

      _startLoading: function() {
        const ide = this._ide();
        if (ide) ide.startLoading("isLoadingProjects");
      },

      _stopLoading: function() {
        const ide = this._ide();
        if (ide) ide.stopLoading("isLoadingProjects");
      },

      _resizePopup: function() {
        document.querySelector("#projectSelectorModal").notifyResize();
      },

      _goTo: function(route) {
        return document.querySelector("app-router").go(route);
      },

      _isEmpty: function(exercises) {
        return exercises.length === 0;
      },

      _guideLoader() {
        return window.GBS_DESKTOP
          ? DesktopGuideLoader
          : GitHubGuideLoader;
      },

      _ide() {
        return document.querySelector("#gobstones-ide");
      }
    });

  </script>
</dom-module>
