<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/leftMenuBehavior.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../scripts/loaders/remote/urlLoader.html">

<dom-module id="gobstones-ide">
  <template>

    <div class="panel-container">
      <div class="panel-left">
        <editor-toolbar project-type="[[projectType]]" id="toolbar"></editor-toolbar>

        <template is="dom-if" if="{{isBlocksProject(projectType)}}">
          <gobstones-blockly id="editor"></gobstones-blockly>
        </template>

        <template is="dom-if" if="{{isCodeProject(projectType)}}">
          <gobstones-editor id="editor"></gobstones-editor>
        </template>
      </div>

      <div class="panel-right">
        <boards-panel id="boards"></boards-panel>
      </div>
    </div>

  </template>

  <script>

    // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    Polymer({
      is: 'gobstones-ide',
      listeners: {
        "show-code-changed": "_showCodeChanged",
        "show-boards-changed": "_showBoardsChanged"
      },
      behaviors: [
        Polymer.LocalizationBehavior,
        Polymer.LeftMenuBehavior,
      ],
      properties: {
        projectType: String
      },

      ready: function() {
        const getContext = this._context.bind(this);
        const projectUrl = getParameterByName("url");
        if (projectUrl) {
          window.LOAD_PENDING_PROJECT = () => {
            new UrlLoader(this.projectType)
              .load(projectUrl, getContext)
              .catch(() => {
                alert(this.localize("error-loading-project-from-url"));
              });
          };
        }
      },

      isBlocksProject: function(projectType) { return projectType === 'blocks'; },
      isCodeProject: function(projectType) { return projectType === 'code'; },

      buttonCssClass: function(show) {
        return !show ? "button-disabled" : "";
      },

      _showCodeChanged: function({ detail }) {
        this._resizeLeftPanel(detail, 0);
      },

      _showBoardsChanged: function({ detail }) {
        this._resizeLeftPanel(detail, $(document).width());
      },

      _resizeLeftPanel: function(show, size) {
        $(".panel-left").width(
          show ? $(document).width() * 0.6 : size
        );
        $(window).trigger("resize");
      }
    });

  </script>
</dom-module>
