<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/parser.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../scripts/simplemde.html">

<dom-module id="gobstones-teacher">
  <template>

    <style>
      paper-tab {
        --paper-tab-content-unselected: {
          opacity: 0.5;
        }
      }

      .editor {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
      }

      .visible {
        visibility: visible;
      }

      .unvisible {
        visibility: hidden;
      }
    </style>

    <div>
      <paper-tabs id="editorTab" selected="{{selectedTab}}" class="bottom self-end">
        <paper-tab>[[localize("code")]]</paper-tab>
        <paper-tab>[[localize("blocks")]]</paper-tab>
        <paper-tab>[[localize("students-library")]]</paper-tab>
        <paper-tab>[[localize("teachers-library")]]</paper-tab>
        <paper-tab>[[localize("description")]]</paper-tab>
        <paper-tab>[[localize("settings")]]</paper-tab>
      </paper-tabs>

      <div style="position: relative">
        <gobstones-editor id="code-editor" class$="editor {{_codeClass(selectedTab)}}"></gobstones-editor>

        <gobstones-blockly id="blocks-editor" class$="editor {{_blocksClass(selectedTab)}}"></gobstones-blockly>

        <gobstones-editor id="library-editor" class$="editor {{_libraryClass(selectedTab)}}"></gobstones-editor>

        <gobstones-editor id="teacher-library-editor" class$="editor {{_teacherLibraryClass(selectedTab)}}"></gobstones-editor>

        <description-editor id="description-editor" class$="editor {{_descriptionClass(selectedTab)}}"></description-editor>

        <div id="metadata-editor" class$="editor {{_metadataClass(selectedTab)}}">Metadata</div>
      </div>
    </div>

  </template>

  <script>

    const ID_CODE = 0;
    const ID_BLOCKS = 1;
    const ID_LIBRARY = 2;
    const ID_TEACHER_LIBRARY = 3;
    const ID_DESCRIPTION = 4;
    const ID_METADATA = 5;

    Polymer({
      is: "gobstones-teacher",
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.LocalizationBehavior
      ],
      properties: {
        selectedTab: {
          type: Number,
          value: 0
        },
        runner: {
          type: Object,
          computed: "_computeRunner(selectedTab)"
        }
      },
      listeners: {
      },

      ready: function() {
      },

      addCode: function(xml) {
        return this._currentEditor().addCode(xml);
      },

      setCode: function(code, mode) {
        const isBlocklyCode = code.startsWith("<");

        return this._editors()[
          mode === "library"
            ? ID_LIBRARY
            : (
              mode === "teacher"
                ? ID_TEACHER_LIBRARY
                : (isBlocklyCode ? ID_BLOCKS : ID_CODE)
            )
        ].setCode(code);
      },

      undo: function() {
        return this._currentEditor().undo();
      },

      increaseFontSize: function() {
        return this._currentEditor().increaseFontSize();
      },

      decreaseFontSize: function() {
        return this._currentEditor().decreaseFontSize();
      },

      generateCode: function(withRegions, blockly) {
        return this._editors()[ID_BLOCKS].generateCode(withRegions, blockly);
      },

      reset: function() {
        return this._editors().forEach((editor) => editor.reset && editor.reset());
      },

      _codeClass: (selectedTab) => selectedTab === ID_CODE ? "visible" : "unvisible",
      _blocksClass: (selectedTab) => selectedTab === ID_BLOCKS ? "visible" : "unvisible",
      _libraryClass: (selectedTab) => selectedTab === ID_LIBRARY ? "visible" : "unvisible",
      _teacherLibraryClass: (selectedTab) => selectedTab === ID_TEACHER_LIBRARY ? "visible" : "unvisible",
      _descriptionClass: (selectedTab) => selectedTab === ID_DESCRIPTION ? "visible" : "unvisible",
      _metadataClass: (selectedTab) => selectedTab === ID_METADATA ? "visible" : "unvisible",

      _editors: function() {
        return [
          "code-editor", "blocks-editor",
          "library-editor", "teacher-library-editor",
          "description-editor", "metadata-editor"
        ].map((it) => this.$[it]);
      },

      _currentEditor: function(selectedTab = this.selectedTab) {
        return this._editors()[selectedTab];
      },

      _computeRunner: function(selectedTab) {
        return this._currentEditor(selectedTab).runner;
      }
    });

  </script>
</dom-module>
