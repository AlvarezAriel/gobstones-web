<script>
  class InteractiveRunner {
    constructor(parser) {
      this.parser = parser;
    }

    run({ ast, request, throttle, callbacks: { onResult, onStop } }) {
      const controller = this._interpret(ast, request, request);

      onResult(controller.context.board());

      const result = controller.onKey("K_J");
      if (!result.error) {
        onResult(result.board());
      } else {
        this._handleError(result, request.code);
        onStop();
      }
    }

    clear() {

    }

    _interpret({ program }, { initialState, code }) {
      return this.parser.interpret(program, initialState);
    }

    _handleError(e, code) {
      e.error.location = this.parser.getErrorLineAndMode(e.error, code);
      return [e];
    }
  }
</script>
