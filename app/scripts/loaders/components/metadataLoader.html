<link rel="import" href="../textLoader.html">
<link rel="import" href="mixins/singleFileComponent.html">

<script>
  class MetadataLoader extends TextLoader {
    constructor() {
      super();
      _.defaults(this, SingleFileComponent);

      this.SUFFIX = ".json";
      this.shouldHandle = (path) => {
        return !_.includes(path, "/") && _.endsWith(path, this.SUFFIX);
      };

      this.SPEED_NAMES = ["low", "medium", "high", "instantaneous"];
    }

    buildContent(context) {
      return JSON.stringify({
        name: context.getProjectName(),
        type: context.ide.projectType,
        library: {
          visible: true // TODO: Deshardcodear
        },
        board: {
          active: context.boards.selectedInitialState + 1,
          initial_board_source: context.editor.runner.useRandomBoard ? "random" : "selected",
          //visible_edition: true, // TODO: Hacer esto (posibilidad de ocultar parte de edición de tableros)
          user_permissions: { // TODO: Deshardcodear
            can_change_source: true,
            can_edit_board: true
          }
        },
        execution_speed: {
          active: this.SPEED_NAMES[context.editor.runner.speed - 1],
          user_permissions: {
            can_change_speed: true // TODO: Deshardcodear
          }
        },
        attire: {
          active: context.boards.attire != null
            ? context.boards.attire.name
            : null,
          visible: context.boards.showAttire,
          user_permissions: {
            can_toggle_visibility: true // TODO: Deshardcodear
          }
        }
      }, null, 2);
    }

    readContent(context, content, fileName) {
      const metadata = JSON.parse(content);

      context.setProjectName(metadata.name);
      // TODO: Redireccionar según type
      // TODO: Leer library visible
    }
  }
</script>
