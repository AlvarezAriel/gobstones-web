<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="course-selector">
  <style>
    .input-course {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .input-course-input {
      width: 70%;
    }

    .input-course-button {
      margin-top: 15px;
      margin-left: 15px;
    }

    .available-courses {
      margin-top: 30px;
      margin-bottom: 30px;
    }
  </style>

  <template>
    <h1>[[localize("course")]]</h1>

    <form action="javascript:void(0);">
      <div class="input-course">
        <paper-input class="input-course-input" label$="{{localize('insert-course-slug')}}" value="{{slug}}"></paper-input>

        <template is="dom-if" if="{{isDesktop()}}">
          <button class="input-course-button" class="submit" type="submit" on-click="downloadCourse">Descargar curso</button> <!-- // TODO: i18n -->
        </template>
        <template is="dom-if" if="{{!isDesktop()}}">
          <button class="input-course-button" class="submit" type="submit" on-click="goToCourse">[[localize("go-to-course")]]</button>
        </template>
      </div>
    </form>

    <template is="dom-if" if="{{availableCourses.length}}">
      <h1 class="available-courses">[[localize("available-courses")]]</h1>
      <template is="dom-repeat" items="{{availableCourses}}">
        <li>
          <span hidden$="{{isDesktop()}}">
            <a href="javascript: void(0);" on-click="onGoToClick">[[item.name]]</a>
          </span>
          <span hidden$="{{!isDesktop()}}">
            <span hidden$="{{!item.path}}">
              <a href="javascript: void(0);" on-click="onGoToClick">[[item.name]]</a>
            </span>
            <span hidden$="{{item.path}}">
              [[item.name]]
            </span>
          </span>

          <span hidden$="{{!isDesktop()}}">
            <span hidden$="{{item.isDownloading}}">
              <paper-button style="z-index: 99" on-click="onDownloadCourse"><iron-icon class="black-button" icon="icons:file-download"></iron-icon></paper-button>
              <paper-button style="z-index: 99" on-click="onDeleteCourse"><iron-icon class="black-button" icon="icons:remove"></iron-icon></paper-button>
            </span>

            <span hidden$="{{!item.isDownloading}}">
              <span style="font-size: small; color: gray">
                <span>[[localize("updating")]]</span>
                <span>([[item.downloadProgress]])</span>
              </span>
            </span>
          </span>
        </li>
      </template>
    </template>
  </template>

  <script>
    Polymer({
      is: 'course-selector',
      behaviors: [
        Polymer.LocalizationBehavior
      ],
      properties: {
        slug: String,
        availableCourses: []
      },

      ready: function() {
        this.COURSES_URL = "https://raw.githubusercontent.com/wiki/gobstones/gobstones-web/Courses.md";

        this.slug = getParameterByName("course");
        this._loadCourses();
      },

      goToCourse: function() {
        if (_.isEmpty(this.slug)) return;

        this.goTo(this.slug);
      },

      downloadCourse: function() {
        if (_.isEmpty(this.slug)) return;

        this.requestDownload({ course: this.slug });
      },

      onGoToClick: function(event) {
        this.goTo(event.model.item.course);
      },

      onDownloadCourse: function(event) {
        this.requestDownload(event.model.item);
      },

      onDeleteCourse: function(event) {
        const course = event.model.item;
        this._saveCourses(this.availableCourses.filter((it) => it !== course));
      },

      goTo: function(slug) {
        document.location.search = "?course=" + slug;
      },

      requestDownload: function(course) {
        const slug = course.course;
        const dialog = window.GBS_REQUIRE("electron").remote.dialog;
        const fs = window.GBS_REQUIRE("fs");

        const paths = dialog.showOpenDialog({
          title: "DAME EL PATH DONDE LO QUERÉS PONER", // TODO: i18n
          buttonLavel: "GUARDARLO ACÁ",
          properties: ["openDirectory"],
          defaultPath: course.path
        });

        if (!paths || !paths[0]) return;
        const path = paths[0];

        // TODO: Empezar a usar AppImage ahora que ya no usamos más GBS_DIRNAME
        // TODO: Agregar botón para cambiar de directorio
        // TODO: Arreglar descargas simultáneas
        // TODO: Recordar el último curso abierto

        if (fs.existsSync(`${path}/content`)) {
          alert("El directorio ya tiene contenido. Asegurate de que esté vacío."); // TODO: i18n
          return;
        }

        this._saveCourses(_.uniqBy(this.availableCourses.concat({
          name: slug,
          course: slug
        }), "course"));

        this._download(this._getCourse(slug), path);
      },

      isDesktop: function() {
        return window.GBS_DESKTOP;
      },

      _download: function(course, path) {
        const bytes = window.GBS_REQUIRE("bytes");

        course.isDownloading = true;
        course.downloadProgress = "...";

        const courseSlug = course.course;
        this._updateGlobalDownloadState();
        DesktopGuideLoader.download(courseSlug, (loaded, total) => {
          this._changeCourse(course, (it) => it.downloadProgress = bytes(loaded));
        }, path).then(() => {
          this._changeCourse(course, (it) => {
            it.path = path;
            it.isDownloading = false;
          });
          this._saveCourses();
          this._updateGlobalDownloadState(true);
        }).catch((e) => {
          this._changeCourse(course, (it) => {
            it.isDownloading = false;
          });
          this._updateGlobalDownloadState();
          alert(this.localize("download-course-error"));
        });
      },

      _loadCourses: function() {
        if (this.isDesktop()) {
          this.availableCourses = this._getSavedCourses();
        } else {
          $.getJSON(this.COURSES_URL).then((availableCourses) => {
            this.availableCourses = availableCourses;
          });
        }
      },

      _saveCourses: function(courses = this.availableCourses) {
        window.STORAGE.setItem("courses", courses.map((it) => {
          it.isDownloading = undefined;
          it.downloadProgress = undefined;
          return it;
        }));

        this._loadCourses();
      },

      _updateGlobalDownloadState: function(tryReload = false) {
        const wasEnabled = window.GBS_IS_DOWNLOADING_GUIDE;
        window.GBS_IS_DOWNLOADING_GUIDE = this.availableCourses.some((it) => it.isDownloading);
        if (tryReload && wasEnabled && !window.GBS_IS_DOWNLOADING_GUIDE) this._tryReload();
      },

      _tryReload: function() {
        if (!confirm(this.localize("you-must-reload"))) return;
        location.reload();
      },

      _changeCourse: function(course, func) {
        this.availableCourses = this.availableCourses.map((it) => {
          const newCourse = _.clone(it);
          if (it.course === course.course) func(newCourse);
          return newCourse;
        });
      },

      _getCourse: function(slug) {
        return _.find(this.availableCourses, { course: slug });
      },

      _getSavedCourses: function() {
        return window.STORAGE.getItem("courses") || [];
      }
    });
  </script>
</dom-module>
