<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/gs-board/dist/components/gs-board.html">
<link rel="import" href="../../scripts/parserAndBoardAdapter.html">

<dom-module id="boards-panel">
  <template>

    <style>
      .boards-panel {
        text-align: center;
      }

      .final-board {
        margin-top: 20px;
      }
    </style>

    <div class="boards-panel">
      <div>
        Tablero inicial
      </div>
      <gs-board size='{ "x": 4, "y": 4 }' id="initialStateEditor" options='{ "editable": true }'></gs-board>

      <template is="dom-if" if="{{finalState}}">
        <div class="final-board">
          Tablero final (resultado)
        </div>
        <gs-board size='{ "x": 4, "y": 4 }' header="{{finalState.header}}" board='{{finalState.board}}'></gs-board>
      </template>
    </div>

  </template>

  <script>

    Polymer({
      is: 'boards-panel',
      properties: {
        finalState: Object
      },

      ready: function() {
        this._adapter = new ParserAndBoardAdapter();

        this._subscribeToEditor("execution-request", () => {
          this._exposeInitialState();
        });

        this._subscribeToEditor("execution-result", (eventInfo) => {
          this._onExecute(eventInfo.detail);
        });
      },

      _exposeInitialState: function() {
        const initialStateEditor = this.$.initialStateEditor
        const initialState = {
          header: initialStateEditor.header,
          board: this._adapter.adaptToParser(initialStateEditor.board)
        }
        this.fire("initial-state", initialState);
      },

      _onExecute: function(event) {
        const board = event.context.board();

        this._setFinalState({
          header: _.pick(board, "x", "y"),
          board: this._adapter.adaptToBoard(board.table)
        });
      },

      _setFinalState: function(finalState) {
        this.finalState = null;
        this.async(function() {
          this.finalState = finalState;
        });
      },

      _subscribeToEditor: function(eventName, eventHandler) {
        this.async(() => {
          document.querySelector("#editor").addEventListener(eventName, eventHandler);
        });
      }
    });

  </script>
</dom-module>
