<script src="../bower_components/gs-weblang-core/umd/index.umd.min.js"></script>
<script src="../bower_components/gobstones-interpreter/lib/gobstones-interpreter.js"></script>

<script>
  class Parser {
    constructor() {
      const { GobstonesInterpreterAPI } = window["gobstones-interpreter"];
      this.interpreter = new GobstonesInterpreterAPI();
    }

    parse(sourceCode, onError = () => {}, onSuccess = (it) => it) {
      try {
        return onSuccess(this.interpreter.parse(sourceCode));
      } catch (e) {
        if (e.reason) {
          onError(e); // known errors
        }
        else throw e; // unknown errors
      }
    }

    interpret(program, initialState) {
      const board = this._createBoard(initialState);
      return program.interpret(board);
    }

    readGbb(gbb) {
      return this.interpreter.gbb.read(gbb);
    }

    buildGbb(initialState, size) {
      const board = this._createBoard(initialState);
      return this.interpreter.gbb.write(board);
    }

    getErrorLineAndMode(e, code, forceIsInMainCode) {
      const libraryLines = code.library.split("\n").length - 1;

      try {
        const isInMainCode = forceIsInMainCode || e.on.range.start.row > libraryLines;

        return {
          line: e.on.range.start.row - (isInMainCode ? libraryLines : 0),
          mode: isInMainCode ? "main" : "library"
        };
      } catch(unknownError) {
        throw e;
      }
    }

    _createBoard(initialState) {
      return {
        width: initialState.size.x,
        height: initialState.size.y,
        head: {
          x: initialState.header.x,
          y: initialState.header.y
        },
        table: initialState.table
      };
    }
  }
</script>
