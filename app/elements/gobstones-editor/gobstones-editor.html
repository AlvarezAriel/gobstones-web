<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/ace-widget/ace-widget.html">

<dom-module id="gobstones-editor">
  <template>

    <style>
      :host {
        display: block;
        height: 100%;
      }

      ace-widget {
        height: 100%;
        --ace-widget-editor:{
          height: 100% !important;
          @apply(--gobstones-editor);
        }
      }

      .run-button {
        position: absolute;
        bottom: 30px;
        right: 24px;
      }
    </style>

    <ace-widget
      id="ace"
      mode="ace/mode/gobstones"
      theme="ace/theme/chrome"
      tab-size="4"
    >
    </ace-widget>
    <paper-fab icon="av:play-arrow"
               class="run-button"
               on-click="onRunCode"
    ></paper-fab>
  </template>

  <script src="https://npmcdn.com/gs-weblang-core@0.1.7/umd/index.umd.js"
          type="text/javascript"
          charset="utf-8"></script> <!-- // TODO: Mover -->

  <script>

    Polymer({
      is: 'gobstones-editor',
      listeners: {
        "ace.editor-ready": "onAceReady",
        "ace.editor-content": "onContentChange"
      },

      ready: function() {
        this._subscribeToBoards("initial-state", (eventInfo) => {
          this._runCode(eventInfo.detail);
        });
      },

      onAceReady: function() {
        const editor = this.$.ace.editor;
        editor.$blockScrolling = Infinity;
      },

      onContentChange: function(content) {
        const value = content.detail.value;
      },

      onRunCode: function() {
        this.fire("execution-request");
      },

      _runCode: function(initialState) {
        const editor = this.$.ace.editor;
        const sourceCode = this.$.ace.editor.getValue();

        editor.getSession().clearAnnotations();

        try {
          const context = this._parse(sourceCode, initialState);
          this.fire("execution-result", { context: context });
        } catch (e) {
          console.log("CATCHED PARSER ERROR: ", e);
          editor.getSession().setAnnotations([{
            row: e.on.range.start.row,
            column: 0,
            text: e.error,
            type: "error"
          }]);
//          var AceRange = ace.require('ace/range').Range;
//          editor.getSession().addMarker(new AceRange(e.on.range.start.row, e.on.range.start.column, e.on.range.end.row, e.on.range.end.column), "error-line", "fullLine", true);
        }
      },

      _parse: function(sourceCode, initialState) {
        const {
          tokens, interpreter, lexer: Lexer,
          parser: Parser, grammar: Grammar,
          context: Context
        } = window.gsWeblangCore;

        const context = this._createContext(Context, initialState);
        const grammar = Grammar(Parser, new Lexer(), tokens, interpreter);
        const ast = grammar.parseProgram(sourceCode);

        try {
          grammar.interpret(ast, context);
        } catch (e) {
          if (e.error) {
            editor.getSession().setAnnotations([{
              row: e.on.start.row,
              column: 0,
              text: e.error,
              type: "error"
            }]);
          }
        }

        return context;
      },

      _createContext: function(Context, initialState) {
        const context = new Context();
        context.board().sizeX = 4; // TODO: Unharcode here and in weblang-core
        context.board().sizeY = 4;
        context.init();

        context.board().table = initialState;
        // TODO: Esto en realidad es la table. Hacer que incluya el cabezal.

        return context;
      },

      _subscribeToBoards: function(eventName, eventHandler) {
        this.async(() => {
          document.querySelector("#boards").addEventListener(eventName, eventHandler);
        });
      }
    });

  </script>
</dom-module>
