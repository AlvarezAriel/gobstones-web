<link rel="import" href="jquery.html">

<script>

  class Stylist {
    constructor() {
      this.toolboxVisible = true;

      this.SCALE = 0.8;
      this.DEFAULT_PERCENTAGE = 0.6;
      this.TOOLBAR_HEIGHT = 64;
      this.TOOLBOX_HEIGHT = 86;
      this.TOOLBAR_AND_TOOLBOX_HEIGHT = () => this.TOOLBAR_HEIGHT + (this.toolboxVisible ? this.TOOLBOX_HEIGHT : 0);

      this.BOARD_CSS_CLASS = ".theBoard";
      this.BOARD_CONTAINER_CSS_CLASS = ".theBoardContainer";
      this.LEFT_PANEL_CSS_CLASS = ".panel-left";
    }

    correctEditorHeight(editor) {
      const lineHeight = editor.renderer.lineHeight;
      const availableLines = ($(document).height() - this.TOOLBAR_HEIGHT) / editor.renderer.lineHeight;

      editor.setOption("minLines", availableLines);
      editor.setOption("maxLines", availableLines);
    }

    setPanelAsResizable(boardDimensions) {
      $(document).ready(() => {
        this._makeResizable();
        setTimeout(() => {
          $(`${this.LEFT_PANEL_CSS_CLASS} .ui-resizable-s`).hide();
          $(`${this.LEFT_PANEL_CSS_CLASS} .ui-resizable-se`).hide();

          this.refresh();
        }, 0);
      });

      $(window).resize(() => {
        this.refresh();
      });
    }

    setBlocklyResize() {
      const resize = () => {
        const panel = $(this.LEFT_PANEL_CSS_CLASS);
        $("#blocklyDiv").css("width", panel.width() + "px");
        $("#blocklyDiv").css("height", panel.height() - this.TOOLBAR_HEIGHT + "px");
      };

      setTimeout(resize, 0);
      $(window).resize(resize);
    }

    refresh() {
      var percentage = this._keepAspectRatioOnWindowResize(this.LEFT_PANEL_CSS_CLASS);
      this._scaleAndCenterBoard(percentage);
    }

    _keepAspectRatioOnWindowResize() {
      const documentWidth = $(document).width()
      if (!this.lastDocumentWidth) {
        this.lastDocumentWidth = documentWidth;
        return this.DEFAULT_PERCENTAGE;
      }

      const percentage = this._getPercentage();

      const leftPanel = $(this.LEFT_PANEL_CSS_CLASS);
      leftPanel.width(documentWidth * percentage);
      this.lastDocumentWidth = documentWidth;

      return percentage;
    }

    _scaleAndCenterBoard(percentage) {
      const board = this._getBoard();

      board.css({ opacity: 0, transform: "scale(1)" });
      const scale = this._getScale(percentage);
      this._centerBoard(percentage, scale);
      board.css({ opacity: 1, transform: `scale(${scale})` });
    }

    _centerBoard(percentage, scale) {
      // center vertically
      const middleY = this._getRightPanelHeight() / 2;
      const offsetY = this._getBoardHeight() / 2;
      $(this.BOARD_CSS_CLASS).css("margin-top", `${middleY - offsetY}px`);
      console.log("totalY", middleY - offsetY, "(", middleY, "-", offsetY, ")", " - scale", scale, "- height", this._getBoardHeight())

      // center horizontally
      $(".theBoardContainer").width(0); // avoid increasing container width
      const panelWidth = this._getRightPanelWidth(percentage);
      const middleX = panelWidth / 2;
      const offsetX = this._getBoardWidth() / 2;

      this._getBoard().css("margin-left", `${middleX - offsetX}px`);
      console.log("totalX", middleX - offsetX, "(", middleX, "-", offsetX, ")", " - scale", scale, "- width", this._getBoardWidth())
    }

    _makeResizable() {
      $(this.LEFT_PANEL_CSS_CLASS).resizable({
        resizeHeight: false
      });
    }

    _getPercentage() {
      const leftPanel = $(this.LEFT_PANEL_CSS_CLASS);
      return leftPanel.width() / this.lastDocumentWidth;
    }

    _getRightPanelWidth(percentage) {
      return $(document).width() * (1 - percentage);
    }

    _getRightPanelHeight() {
      return $(document).height() - this.TOOLBAR_AND_TOOLBOX_HEIGHT();
    }


    _getBoardWidth() {
      return this._getBoard().width();
    }

    _getBoardHeight() {
      return this._getBoard().height();
    }

    _getScale(percentage) {
      const panelWidth = this._getRightPanelWidth(percentage);
      const scaleX = panelWidth / this._getBoardWidth();

      const panelHeight = this._getRightPanelHeight();
      const scaleY = panelHeight / this._getBoardHeight();

      console.log("panelHeight / boardHeight =", panelHeight, "/", this._getBoardHeight())
      console.log("scaleX", scaleX, "scaleY", scaleY);
      return Math.max(Math.min(scaleX, scaleY) * this.SCALE, 0);
    }

    _getBoard() {
      return $(".theBoardContainer").find(".gbs_board").first();
    }
  }

</script>
