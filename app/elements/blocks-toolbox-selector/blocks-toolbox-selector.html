<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="blocks-toolbox-item">
  <template>
    <style>
      ul {
        list-style-type: none;
      }

      .check {
        vertical-align: super;
      }

      .toggle {
        display: inline;
        margin-left: 10px;
      }

      .enabled {
        text-decoration: inherit;
      }

      .disabled {
        text-decoration: line-through;
      }
    </style>

    <li><paper-tristate-checkbox class="check" state="{{state}}"><span class$="{{enabledCss(item.*)}}">{{item.alias}}</span></paper-tristate-checkbox><paper-toggle-button class="toggle" checked="{{item.enabled}}"></paper-toggle-button></li>

    <template is="dom-if" if="{{item.children}}">
      <ul>
        <template is="dom-repeat" items="{{item.children}}">
          <blocks-toolbox-item item="{{item}}"></blocks-toolbox-item>
        </template>
      </ul>
    </template>
  </template>

  <script>
    Polymer({
      is: 'blocks-toolbox-item',
      properties: {
        item: {
          type: Object,
          observer: "_onItemChanged"
        },
        previousState: String,
        state: {
          type: String,
          observer: "_onCheckboxChanged"
        }
      },
      listeners: {
        "child-changed": "_onChildChanged"
      },

      enabledCss: function({ base: item }) {
        return item.enabled ? "enabled" : "disabled";
      },

      _onItemChanged: function() {
        this.state = this.item.state;
      },

      _onCheckboxChanged: function() {
        if (this.state === "off") {
          this.item.setVisible(false);
          this.fire("child-changed", { item: this.item, visible: false });
        }

        if (this.state === "on") {
          this.item.setVisible(true);
          this.fire("child-changed", { item: this.item, visible: true });
        }

        if (this.state === null && !this._isEditingChild)
          this.state = "on";

        this
          .querySelectorAll("blocks-toolbox-item")
          .forEach((it) => it._onItemChanged());
      },

      _onChildChanged: function({ detail: { item, visible } }) {
        this._isEditingChild = true;
        const child = _.find(this.item.children, (it) => it.alias === item.alias);
        if (child) child.visible = visible;
        this._onItemChanged();
        this._isEditingChild = false;

        this.fire("toolbox-changed");
      }
    });
  </script>
</dom-module>

<dom-module id="blocks-toolbox-selector">
  <template>
    <style>
      ul {
        list-style-type: none;
      }
    </style>

    <ul>
      <template is="dom-repeat" items="{{_blocks}}">
        <blocks-toolbox-item item="{{item}}"></blocks-toolbox-item>
      </template>
    </ul>
  </template>

  <script>
    Polymer({
      is: 'blocks-toolbox-selector',
      properties: {
        blocks: Object,
        _blocks: Array
      },
      listeners: {
        "toolbox-changed": "_onBlocksUpdate"
      },

      ready: function() {
        // TODO: Inicializar desde this.blocks

        const tree = Blockly.Xml.textToDom(`
          <xml id="toolbox" style="display: none">
            <category name="Comandos">
              <category name="Comandos primitivos">
                <block type="Poner"></block>
                <block type="Sacar"></block>
                <block type="Mover"></block>
                <block type="IrAlBorde"></block>
                <block type="VaciarTablero"></block>
                <block type="BOOM"></block>
              </category>
              <category name="Procedimientos primitivos">
              </category>
              <category name="Mis procedimientos" custom="PROCEDURE_CALLS">
              </category>
              <category name="Alternativas">
                <block type="AlternativaSimple"></block>
                <block type="AlternativaCompleta"></block>
              </category>
              <category name="Repeticiones">
                <block type="RepeticionSimple"></block>
                <block type="RepeticionCondicional"></block>
              </category>
              <category name="AsignaciÃ³n">
                <block type="Asignacion"></block>
              </category>
            </category>
            <category name="Expresiones">
              <category name="Literales">
                <block type="math_number"></block>
                <block type="ColorSelector"></block>
                <block type="DireccionSelector"></block>
                <block type="BoolSelector"></block>
              </category>
              <category name="Expresiones primitivas">
                <block type="hayBolitas"></block>
                <block type="puedeMover"></block>
                <block type="nroBolitas"></block>
              </category>
              <category name="Funciones primitivas">
              </category>
              <category name="Mis funciones" custom="FUNCTION_CALLS">
              </category>
              <category name="Operadores">
                <block type="OperadorNumerico"></block>
                <block type="OperadorDeComparacion"></block>
                <block type="OperadorLogico"></block>
                <block type="not"></block>
                <block type="siguiente"></block>
                <block type="previo"></block>
                <block type="opuesto"></block>
              </category>
            </category>
            <category name="Definiciones">
              <category name="Programas">
                <block type="Program"></block>
                <block type="InteractiveProgram"></block>
              </category>
              <category name="Asociaciones">
                <block type="InteractiveLetterBinding"></block>
                <block type="InteractiveNumberBinding"></block>
                <block type="InteractiveKeyBinding"></block>
              </category>
              <category name="Procedimientos">
                <block type="procedures_defnoreturnnoparams"></block>
                <block type="procedures_defnoreturn"></block>
              </category>
              <category name="Funciones">
                <block type="procedures_defreturnsimple"></block>
                <block type="procedures_defreturnsimplewithparams"></block>
                <block type="procedures_defreturn"></block>
              </category>
            </category>
            <category name="Auxiliares Docente">
              <block type="ComandoCompletar"></block>
              <block type="ExpresionCompletar"></block>
              <block type="AsociacionDeTeclaCompletar"></block>
            </category>
          </xml>
        `);

        this._blocks = this._buildBlocks(tree);
      },

      _buildBlocks(rootNode) {
        const toArray = (arrayLike) => Array.apply(null, arrayLike);

        return _(toArray(rootNode.children))
          .map((node) => {
            const name = node.attributes[0].value;
            if (!name) return;

            const alias = _.findKey(
              Blockly.GobstonesLanguage.blockIDAliases,
              (it) => it === name
            );

            return {
              name: name,
              alias: alias || name,
              visible: true,
              enabled: true,
              children: this._buildBlocks(node),
              setVisible: function(isVisible) {
                this.visible = isVisible;
                this.children.forEach((it) => it.setVisible(isVisible));
              },
              get state() {
                const isChecked = (it) => it.visible && it.children.every(isChecked);
                const hasChildren = this.children.length > 0;
                const allChildrenChecked = this.children.every(isChecked);
                const noneChildrenChecked = this.children.every((it) => !it.visible);

                return hasChildren
                  ? (
                    allChildrenChecked ? "on" : (noneChildrenChecked ? "off" : null)
                  ) : (
                    this.visible ? "on" : "off"
                  );
              }
            };
          })
          .compact()
          .value();
      },

      _onBlocksUpdate() {
        if (!this.__onBlocksUpdate)
          this.__onBlocksUpdate = _.debounce(() => {
            const visible = this._getVisibleBlocks(this._blocks);

            this.blocks = {
              visible: visible,
              disabled: visible.filter((it) => !it.enabled)
            };

            console.log("LOS DESACTIVADOS SON", this.blocks.disabled);
          }, 100);

        this.__onBlocksUpdate();
      },

      _getVisibleBlocks(array) {
        return _(array)
          .reject({ state: "off" })
          .flatMap((it) => {
            return it.state === "on"
              ? it.alias
              : this._getVisibleBlocks(it.children)
          })
          .value();
      }
    });
  </script>
</dom-module>
