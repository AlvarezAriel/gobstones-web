<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/loaderBehavior.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../scripts/showdown.html">
<link rel="import" href="../../scripts/loaders/remote/urlLoader.html">
<link rel="import" href="../../scripts/loaders/remote/gitHubLoader.html">

<dom-module id="gobstones-ide">
  <style>
    .loading {
      text-align: center;
      width: 100%;
      font-weight: bold;
      font-size: xx-large;
    }

    .description {
      min-width: 500px;
    }

    .accept {
      cursor: pointer;
    }
  </style>

  <template>

    <div class="panel-container">
      <template is="dom-if" if="{{isLoading}}">
        <div class="loading">[[localize("loading-project")]]</div>
      </template>

      <template is="dom-if" if="{{!isLoading}}">
        <div class="panel-left">
          <editor-toolbar project-type="[[projectType]]" id="toolbar"></editor-toolbar>

          <template is="dom-if" if="{{isBlocksProject(projectType)}}">
            <gobstones-blockly id="editor"></gobstones-blockly>
          </template>

          <template is="dom-if" if="{{isCodeProject(projectType)}}">
            <gobstones-editor id="editor"></gobstones-editor>
          </template>
        </div>

        <div class="panel-right">
          <boards-panel id="boards"></boards-panel>
        </div>

        <paper-dialog id="modal" class="description">
          <paper-dialog-scrollable>
            <div inner-h-t-m-l="[[compileMd(modalContent)]]"></div>
          </paper-dialog-scrollable>

          <div class="buttons">
            <paper-button class="accept" dialog-confirm autofocus>[[localize("accept")]]</paper-button>
          </div>
        </paper-dialog>
      </template>
    </div>

  </template>

  <script>

    // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    Polymer({
      is: 'gobstones-ide',
      listeners: {
        "show-code-changed": "_showCodeChanged",
        "show-boards-changed": "_showBoardsChanged"
      },
      behaviors: [
        Polymer.LocalizationBehavior,
        Polymer.LoaderBehavior,
      ],
      properties: {
        projectType: String,
        isLoading: {
          type: Boolean,
          value: false
        },
        modalContent: {
          type: String,
          value: ""
        }
      },

      ready: function() {
        this._setUpLoaders();
      },

      setModal: function(markdown) {
        this.modalContent = markdown;
        window.BUS.fire("has-description", markdown !== "");
      },

      toggleModal: function() {
        document.querySelector("#modal").toggle();
      },

      isBlocksProject: function(projectType) { return projectType === 'blocks'; },
      isCodeProject: function(projectType) { return projectType === 'code'; },

      compileMd: function(markdown) {
        return new showdown.Converter().makeHtml(markdown);
      },

      buttonCssClass: function(show) {
        return !show ? "button-disabled" : "";
      },

      _showCodeChanged: function({ detail }) {
        this._resizeLeftPanel(detail, 0);
      },

      _showBoardsChanged: function({ detail }) {
        this._resizeLeftPanel(detail, $(document).width());
      },

      _resizeLeftPanel: function(show, size) {
        $(".panel-left").width(
          show ? $(document).width() * 0.6 : size
        );
        $(window).trigger("resize");
      },

      _setUpLoaders: function() {
        const getContext = this._context.bind(this);

        const projectUrl = getParameterByName("url");
        if (projectUrl)
          return this._setUpLoader(UrlLoader, projectUrl, getContext);

        const gitHubSlug = getParameterByName("github");
        if (gitHubSlug)
          return this._setUpLoader(GitHubLoader, gitHubSlug, getContext);
      },

      _setUpLoader: function(Loader, url, getContext) {
        window.LOAD_PENDING_PROJECT = () => {
          this.isLoading = true;

          new Loader(this.projectType)
            .load(url, getContext)
            .catch((e) => {
              console.error(e);
              alert(this.localize("error-loading-project"));
            }).always(() => {
              this.isLoading = false;
            });
        };
      }
    });

  </script>
</dom-module>
