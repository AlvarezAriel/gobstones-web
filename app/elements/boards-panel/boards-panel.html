<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/gs-board/dist/components/gs-board.html">

<dom-module id="boards-panel">
  <template>
    <div style="text-align: center;">
      <div>
        Tablero inicial
      </div>
      <gs-board size='{ "x": 2, "y": 2 }' options='{ "editable": true }'></gs-board>

      <template is="dom-if" if="{{finalState}}">
        <div style="margin-top: 20px;">
          Tablero final (resultado)
        </div>
        <gs-board header="{{finalState.header}}" board='{{finalState.board}}'></gs-board>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'boards-panel',
      properties: {
        finalState: Object
      },
      ready: function() {
        var self = this;
        this.async(function() {
          document.querySelector("#ide").addEventListener("execution-result", function(eventInfo) {
            self.onExecute(eventInfo.detail);
          })
        })
      },

      onExecute: function(event) {
        var board = event.context.board();
        var header = _.pick(board, "x", "y");
        var adaptedTable = this._adaptTableFromCompilerToBoard(board.table);

        this._setFinalState({
          header: header,
          board: adaptedTable
        });
      },

      _adaptTableFromCompilerToBoard: function(table) {
        // TODO: Mover a alg√∫n adapter
        var mapColor = function(index, color) {
          return table[index].map(function(rows) {
            return rows.map(function(amount) {
              var cell = {};
              cell[color] = amount;
              return cell;
            });
          });
        };

        var blueColumns = mapColor(0, "blue");
        var redColumns = mapColor(1, "red");
        var blackColumns = mapColor(2, "black");
        var greenColumns = mapColor(3, "green");

        return _(blueColumns)
          .zipWith(redColumns, blackColumns, greenColumns, _.merge)
          .unzip()
          .reverse()
          .value()
      },

      _setFinalState: function(finalState) {
        this.finalState = null;
        this.async(function() {
          this.finalState = finalState;
        });
      }
    });
  </script>
</dom-module>
