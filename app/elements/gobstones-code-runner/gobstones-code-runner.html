<dom-module id="gobstones-code-runner">

  <template>
    <style>
    </style>

    <div>
      <paper-fab id="gbsPlayButton"
                 icon="av:play-arrow"
                 on-click="_onButtonClick"
      ></paper-fab>
    </div>
  </template>

  <script>
    // TODO: Mover a https://github.com/gobstones/gobstones-code-runner

    Polymer({
      is: 'gobstones-code-runner',

      properties: {
        isRunning: {
          type: Boolean,
          value: false,
          notify: true,
          observer: "_onUpdate"
        }
      },

      start: function(request) {
        this._checkRequiredProperties(request, ["initialBoard", "code", "targetBoard"]);
        if (this.isRunning) this.stop();

        const { initialBoard, code, targetBoard, runningSpeed = 3 } = request;
        // TODO: Run

        this.isRunning = true;
        this.fire("gbs-start");
      },

      stop: function(reason = "canceled") {
        this.isRunning = false;
        this.fire("gbs-stop", reason);
      },

      _onButtonClick: function() {
        if (!this.isRunning) {
          this.fire("gbs-run-request", {
            start: this.start.bind(this),
            stop: this.stop.bind(this)
          });
        } else {
          this.stop();
        }
      },

      _setRunner: function(ast) {
        this.runner = this._isInteractive(ast)
          ? new InteractiveRunner(this.parser)
          : new NormalRunner(this.parser);
      },

      _clear: function() {
        this.runner.clear();
      },

      // TODO: CambiÃ© la interfaz, arreglar el llamado de code-runner
      _checkAndGetTeacherAst: function(code, { onLibraryError, onTeacherError }, onSuccess) {
        this._checkLibraryCompiles(code.library, onLibraryError, () => {
          return this._checkLibraryCompiles(
            code.teacher,
            onTeacherError,
            onSuccess
          );
        });
      },

      _checkLibraryCompiles: function(sourceCode, onError, onSuccess) {
        this._parse({ library: sourceCode, main: "", teacher: "" }, onError, onSuccess);
      },

      _parse: function(code, onError, onSuccess, forceMainCodeLineNumbers) {
        const sourceCode = code.library + "\n" + code.main + "\n" + code.teacher;

        this.parser.parse(sourceCode, e => {
          e.location = this.parser.getErrorLineAndMode(e, code, forceMainCodeLineNumbers);
          return onError(e, code);
        }, onSuccess);
      },

      _isInteractive: function(ast) {
        return ast && ast.program && ast.program.alias === "interactiveProgram";
      },

      _checkRequiredProperties: function(request, properties) {
        const missingProperties = _(request).keys().filter((it) => properties[it]).value();
        if (missingProperties.length > 0) {
          throw new Error(`Missing properties: ${missingProperties.join(", ")}`);
        }
      },

      _onUpdate: function() {
        this.$.gbsPlayButton.icon = this.isRunning ? "av:stop" : "av:play-arrow";
      }
    });
  </script>
