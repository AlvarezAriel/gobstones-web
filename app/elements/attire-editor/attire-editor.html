<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/behaviors/permissionsBehavior.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/loaderBehavior.html">

<dom-module id="attire-editor">
  <template>
    <style>
      .button-tooltip {
        font-size: 15px;
        width: 150px;
        text-align: center;
      }

      .buttons {
        position: absolute;
        right: 0;
      }

      .content {
        margin-top: 20px;
        margin-left: 20px;
      }

      .no-attires {
        color: cornflowerblue;
      }

      .rules-container {
        margin-left: 30px;
      }

      .balls-input {
        display: inline-block;
        width: 50px;
      }

      .remove-rule-button {
        margin-left: 10px;
      }
    </style>

    <div class="buttons">
      <paper-button id="add-attire-button" style="z-index: 99" on-click="addAttire"><iron-icon class="black-button" icon="icons:add"></iron-icon></paper-button>
      <paper-tooltip for="add-attire-button" position="bottom" animation-config="{{tooltipAnimation}}">
        <div class="button-tooltip">
          [[localize("tooltip-add-board")]]
        </div>
      </paper-tooltip>

      <paper-button id="remove-attire-button" style="z-index: 99" on-click="removeAttire"><iron-icon class="black-button" icon="icons:remove"></iron-icon></paper-button>
      <paper-tooltip for="remove-attire-button" position="bottom" animation-config="{{tooltipAnimation}}">
        <div class="button-tooltip">
          [[localize("tooltip-remove-board")]]
        </div>
      </paper-tooltip>
    </div>

    <div class="content">
      <template is="dom-if" if="{{attire}}">
        <div>
          <span><strong>Vestimenta:</strong> <i>[[attire.name]]</i> <paper-button id="rename-attire-button" style="z-index: 99" on-click="renameAttire"><iron-icon class="black-button" icon="icons:create"></iron-icon></paper-button></span>
          <paper-tooltip for="rename-attire-button" position="bottom" animation-config="{{tooltipAnimation}}">
            <div class="button-tooltip">
              [[localize("tooltip-remove-board")]]
            </div>
          </paper-tooltip>
          <br>

          <hr>
          <br>

          <div>
            <paper-button id="add-rule-button" style="z-index: 99" on-click="addRule"><iron-icon class="black-button" icon="icons:add"></iron-icon></paper-button>
            <paper-tooltip for="add-rule-button" position="right" animation-config="{{tooltipAnimation}}">
              <div class="button-tooltip">
                [[localize("tooltip-add-board")]]
              </div>
            </paper-tooltip>
          </div>

          <div class="rules-container">
            <template is="dom-repeat" items="{{ attire.rules }}">
              <img src="../../images/stones/red.svg" width="15" height="15" />
              <paper-input class="balls-input" value="{{item.red}}" min="1" max="8"></paper-input>

              <img src="../../images/stones/green.svg" width="15" height="15" />
              <paper-input class="balls-input" value="{{item.green}}" min="1" max="8"></paper-input>

              <img src="../../images/stones/blue.svg" width="15" height="15" />
              <paper-input class="balls-input" value="{{item.blue}}" min="1" max="8"></paper-input>

              <img src="../../images/stones/black.svg" width="15" height="15" />
              <paper-input class="balls-input" value="{{item.black}}" min="1" max="8"></paper-input>

              <paper-button class="remove-rule-button" style="z-index: 99" on-click="removeRule"><iron-icon class="black-button" icon="icons:delete-forever"></iron-icon></paper-button>

              <br>
            </template>
          </div>
        </div>
      </template>

      <template is="dom-if" if="{{!attire}}">
        <h3 class="no-attires">Crea nuevas vestimentas con el ícono (+) de arriba a la derecha.</h3>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'attire-editor',
      properties: {
        attire: {
          type: Object,
          value: null
        }
      },
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.PermissionsBehavior,
        Polymer.LocalizationBehavior,
        Polymer.LoaderBehavior
      ],
      observers: [
      ],

      attached: function() {
        this.tooltipAnimation = {
          "entry": [{"name": "fade-in-animation", "timing": {"delay": 0}}],
          "exit": [{"name": "fade-out-animation", "timing": {"delay": 0}}]
        };
      },

      ready: function() {
        this.subscribeTo("selected-attire", (attire) => {
          if (_.isEqual(attire, {})) attire = null;
          this.attire = attire;
        })
      },

      addAttire: function() {
        const name = this._getUniqueName();
        if (!name) return;

        this._boards().addOrSetAttire({
          name: name,
          enabled: false,
          rules: []
        });
        this._boards().showAttire = true;
      },

      removeAttire: function() {
        this._boards().removeCurrentAttire();
      },

      renameAttire: function() {
        const name = this._getUniqueName();
        if (!name) return;

        this.set("attire.name", name);
        this._update();
      },

      addRule: function() {
        this.push("attire.rules", {
          when: {
            red: "",
            green: "",
            blue: "",
            black: ""
          },
          image: null
        });
        this._update();
      },

      removeRule: function(e) {
        const index = e.model.index;
        this.set("attire.rules", this.attire.rules.filter((it, i) => {
          return i !== index;
        }));
        this._update();
      },

      _getUniqueName: function() {
        let name = null;
        let withExistsWarning = false;

        while (!name) {
          const input = prompt("Ingresa un nombre para la vestimenta" + (withExistsWarning ? " (que no esté siendo usado)" : ""));
          if (!input) return;

          const exists = this._boards().availableAttires.some((it) => it.name === input);

          if (!exists) name = input;
          else withExistsWarning = true;
        }

        return name.slice(0, 25);
      },

      _update: function() {
        this._boards().updateCurrentAttire(this.attire);
      },

      _boards: function() {
        return this._context().boards;
      }
    });
  </script>
</dom-module>
<!-- // TODO: I18n, cambiar tooltips -->
