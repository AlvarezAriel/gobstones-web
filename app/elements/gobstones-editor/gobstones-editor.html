<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/ace-widget/ace-widget.html">

<dom-module id="gobstones-editor">
  <template>

    <style>
      :host {
        display: block;
        height: 100%;
      }

      ace-widget {
        height: 100%;
        --ace-widget-editor:{
          height: 100% !important;
          @apply(--gobstones-editor);
        }
      }

      .run-button {
        position: absolute;
        bottom: 30px;
        right: 24px;
      }
    </style>

    <ace-widget
      id="ace"
      mode="ace/mode/gobstones"
      theme="ace/theme/chrome"
      tab-size="4"
    >
    </ace-widget>
    <paper-fab icon="av:play-arrow"
               class="run-button"
               on-click="onRunCode"
    ></paper-fab>
  </template>

  <script src="https://npmcdn.com/gs-weblang-core@0.2.0/umd/index.umd.js"
          type="text/javascript"
          charset="utf-8"></script> <!-- // TODO: Mover -->

  <script>

    Polymer({
      is: "gobstones-editor",
      listeners: {
        "ace.editor-ready": "onAceReady",
        "ace.editor-content": "onContentChange"
      },

      ready: function() {
        this._subscribeToBoards("initial-state", (eventInfo) => {
          this._runCode(eventInfo.detail);
        });

        this.editor = this.$.ace.editor;
        this._setFatalities();
        this._subscribeToChangeEvents();
      },

      onAceReady: function() {
        this.$.ace.editor.$blockScrolling = Infinity;
      },

      onContentChange: function(content) {
        const value = content.detail.value;
      },

      onRunCode: function() {
        this.fire("execution-request");
      },

      _runCode: function(initialState) {
        this.editor.getSession().clearAnnotations();
        const sourceCode = this.editor.getValue();

        const {
          tokens, interpreter, lexer: Lexer,
          parser: Parser, grammar: Grammar,
          context: Context
        } = window.gsWeblangCore;

        const grammar = Grammar(Parser, new Lexer(), tokens, interpreter);

        const ast = this._parse(sourceCode, grammar);
        if (ast.error) return;
        const context = this._interpret(ast, initialState, grammar, Context);
        if (context.error || context.on) return;

        this.fire("execution-result", { context: context });
      },

      _parse: function(sourceCode, grammar) {
        try {
          return grammar.parseProgram(sourceCode);
        } catch (e) {
          // Parser errors
          this._reportError(e, e.error);

          // var AceRange = ace.require('ace/range').Range;
          // this.editor.getSession().addMarker(new AceRange(e.on.range.start.row, e.on.range.start.column, e.on.range.end.row, e.on.range.end.column), "error-line", "fullLine", true)

          this.fire("compilation-error", e.error);
          return e;
        }
      },

      _interpret: function(ast, initialState, grammar, Context) {
        const context = this._createContext(initialState, Context);

        try {
          grammar.interpret(ast, context);
          return context;
        } catch (e) {
          // Runtime errors
          if (e.error) this._reportError(e, e.error);

          // Business errors
          if (e.on) this._reportError(e, e.message);

          this.fire("execution-error", e.message);
          return e;
        }
      },

      _reportError: function(e, message) {
        this.editor.getSession().setAnnotations([{
          row: e.on.range.start.row,
          column: 0,
          text: message,
          type: "error"
        }]);
      },

      _createContext: function(initialState, Context) {
        const context = new Context();
        context.board().sizeX = initialState.size.x;
        context.board().sizeY = initialState.size.y;
        context.init();

        _.assign(context.board(), {
          x: initialState.header.x,
          y: initialState.header.y,
          table: initialState.table
        });

        return context;
      },

      _subscribeToBoards: function(eventName, eventHandler) {
        this.async(() => {
          document.querySelector("#boards").addEventListener(eventName, eventHandler);
        });
      },

      _setFatalities: function() {
        const ace = this.$.ace;
        ace.focus();
        ace.editor.commands.addCommand({
          name: "run-code",
          bindKey: { win: "ctrl+enter", mac: "command+enter" },
          exec: () => { this.onRunCode() }
        });
        this.$.ace.focus()
      },

      _subscribeToChangeEvents: function() {
        this.editor.getSession().on("change", () => {
          this.editor.getSession().setAnnotations([]);
          this.fire("editor-dirty");
        });
      }
    });

  </script>
</dom-module>
