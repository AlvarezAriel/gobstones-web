<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../scripts/jquery.html">
<link rel="import" href="../../scripts/projectLoader.html">

<dom-module id="left-menu">
  <template>

    <style>
      .title {
        margin: 3px;
      }

      .project-title {
        margin: -20px 30px;
      }

      .items {
        margin-top: 40px;
      }

      .action-text {
        vertical-align: middle;
      }

      .action {
        margin: 10px 0;
      }
    </style>

    <div>
      <save-and-load on-save="saveProject" on-load="loadProject"></save-and-load>
    </div>
    <h1 class="title">[[localize("project")]]</h1>
    <paper-input class="project-title" value="{{projectName}}"></paper-input>

    <div class="items">
      <ul>
        <li class="action">
          <span>[[localize("code")]]</span>
          <save-and-load on-save="saveCode" on-load="loadCode"></save-and-load>
        </li>
        <li class="action">
          <span>[[localize("library")]]</span>
          <save-and-load on-save="saveLibrary" on-load="loadLibrary"></save-and-load>
        </li>
        <!-- <li>Tablero inicial</li> --> <!-- // TODO -->
        <li class="action">
          <span>[[localize("clothing")]]</span>
          <save-and-load on-save="saveClothing" on-load="loadClothing"></save-and-load>
        </li>
      </ul>

      <input id="Code" type="file" accept=".gbs" on-change="onLoadedCode" style="visibility: hidden;" />

      <input id="Library" type="file" accept=".gbs" on-change="onLoadedLibrary" style="visibility: hidden;" />

      <input id="Clothing" type="file" accept=".json" on-change="onLoadedClothing" style="visibility: hidden;" />
    </div>
  </template>

  <script>

    Polymer({
      is: 'left-menu',
      behaviors: [
        Polymer.AppLocalizeBehavior
      ],
      properties: {
        language: { value: "es" },
        projectName: {
          type: String,
          value: "Program"
        }
      },

      attached: function() {
        this.loadResources(this.resolveUrl("../../locales.json"));
        this._projectLoader = new ProjectLoader();

        ["Code", "Library", "Clothing"].forEach(item => {
          this[`load${item}`] = () => { $(`#${item}`).click(); };
        });
      },

      saveCode: function() {
        const code = this._editor().code.main;
        this._saveFile(code, "code", "gbs");
      },

      saveLibrary: function() {
        const code = this._editor().code.library;
        this._saveFile(code, "library", "gbs");
      },

      saveClothing: function() {
        const clothing = this._boards().clothing;
        this._saveFile(JSON.stringify(clothing), "clothing", "json");
      },

      onLoadedCode: function(event) {
        this._loadFile(event, (code) => {
          this.projectName = fileName;
          this._setAndRunCode(code)
        });
      },

      onLoadedLibrary: function(event) {
        this._loadFile(event, (code) => {
          this._setAndRunCode(code, "library")
        });
      },

      onLoadedClothing: function(event) {
        this._loadFile(event, (json) => {
          const clothing = JSON.parse(json);
          if (clothing && clothing.name && clothing.rules)
            this._boards().addOrSetClothing(clothing);
        });
      },

      _saveFile: function(content, type, extension) {
        this._projectLoader.save(
          content,
          `${this.projectName}.${type}.${extension}`
        );
      },

      _loadFile: function(event, callback) {
        this._projectLoader.read(event, (content, fileName) => {
          callback(content, fileName);
          this._closePanel();
        });
      },

      _setAndRunCode: function(code, mode) {
        const editorElement = this._editor();
        editorElement.setCode(code, mode);
        editorElement.onRunCode();
      },

      _closePanel: function() {
        $("paper-drawer-panel")[0].togglePanel();
      },

      _editor: function() {
        return document.querySelector("#editor");
      },

      _boards: function() {
        return document.querySelector("#boards");
      }
    });

  </script>
</dom-module>
