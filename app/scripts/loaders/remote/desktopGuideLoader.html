<link rel="import" href="./fsLoader.html">
<link rel="import" href="./gitHubGuideLoader.html">
<link rel="import" href="../../jquery.html">

<script>
  const guidesPath = `${window.GBS_DIRNAME}/guides`;
  const jsonPath = `${window.GBS_DIRNAME}/guides/guides.json`;
  const tmpPath = `${window.GBS_DIRNAME}/guides_tmp`;

  class DesktopGuideLoader {
    constructor({ exercises }) {
      this.exercises = exercises;
    }

    static download(onProgress) {
      const url = "https://github.com/gobstones/proyectos-jr/archive/master.zip";

      const fs = window.GBS_REQUIRE("fs");
      const extract = window.GBS_REQUIRE("extract-zip");
      const ncp = window.GBS_REQUIRE("ncp");
      window.GBS_REQUIRE("setimmediate");

      const deferred = new $.Deferred();
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.responseType = "arraybuffer";
      xhr.onload = function () {
        if (this.status === 200) deferred.resolve(xhr.response);
        else deferred.reject({ status: this.status });
      };
      xhr.onprogress = function(e) {
        //if (e.lengthComputable) onProgress(e.loaded, e.total);
        onProgress(e.loaded);
      };
      xhr.send();

      return deferred.promise()
        .then((file) => {
          const zipPath = `${window.GBS_DIRNAME}/guides.zip`;
          fs.writeFileSync(zipPath, new Buffer(file));
          try { fs.rmdirSync(tmpPath); } catch (e) { }
          try { fs.rmdirSync(guidesPath); } catch (e) { }
          try { fs.mkdirSync(guidesPath); } catch (e) { }
          const deferred = new $.Deferred();
          extract(zipPath, { dir: tmpPath }, function(err) {
            if (err) deferred.reject(err); else deferred.resolve();
          });
          return deferred.promise();
        }).then(() => {
          const deferred = $.Deferred();
          ncp(`${tmpPath}/proyectos-jr-master`, guidesPath, function(err) {
            if (err) deferred.reject(err); else deferred.resolve();
          });
          return deferred.promise();
        });
    }

    static all() {
      try {
        const json = window.GBS_REQUIRE("fs").readFileSync(
          jsonPath
        );
        const guides = JSON.parse(json);

        return promisify(guides);
      } catch(e) {
        console.warn(e);
        return promisify([]);
      }
    }

    static makeUrlFor(guide, exercise) {
      const path = `${guidesPath}/${exercise.path}`;
      return `/${window.GBS_PROJECT_TYPE}?fs=${path}`;
    }

    getExercises() {
      return promisify(this.exercises.map((exercise) => {
        return _.assign(exercise, {
          imageUrl: this._makeImageUrl(exercise.path)
        });
      }));
    }

    _makeImageUrl(exercise) {
      try {
        const path = `${guidesPath}/${exercise.path}`;

        const bitmap = window.GBS_REQUIRE("fs")
          .readFileSync(`${path}/image.png`)
        const base64 = new Buffer(bitmap).toString("base64");
        return `data:image/png;base64,${base64}`;
      } catch(e) {
        console.warn(e);
        return null;
      }
    }
  }
</script>
