<link rel="import" href="keyCodeAdapter.html">
<link rel="import" href="../keymaster.html">

<script>
  class InteractiveRunner {
    constructor(parser) {
      this.parser = parser;
      this.adapter = new KeyCodeAdapter();
      this.keys = [];
    }

    run({ ast, request, throttle, callbacks: { onResult, onStop } }) {
      const controller = this._interpret(ast, request, request);

      const handleKey = (key) => {
        const result = controller.onKey(key);
        if (!result.error) {
          onResult(result.board());
        } else {
          onResult(this._handleError(result, request.code));
          onStop("end");
        }
      };

      onResult(controller.context.board());

      const boundKeys = controller.keys;
      boundKeys.forEach((it) => {
        const newKey = this.adapter.adapt(it);
        this.keys.push(newKey);
        key(newKey, () => handleKey(it));
      });
    }

    clear() {
      this.keys.forEach(it => key.unbind(it));
      this.keys = [];
    }

    _interpret({ program }, { initialState, code }) {
      return this.parser.interpret(program, initialState);
    }

    _handleError(e, code) {
      e.error.location = this.parser.getErrorLineAndMode(e.error, code);
      return e;
    }
  }
</script>
