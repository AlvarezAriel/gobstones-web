<link rel="import" href"../jquery.html">

<script>
  Polymer.LoaderBehavior = {
    setUpLoaders: function(loaders) {
      this.loaders = loaders;

      _.keys(this.loaders).forEach(item => {
        this[`save${item}`] = () => {
          if (window.GBS_IS_RUNNING) return;
          this.loaders[item].save(this._context());
        };

        this[`load${item}`] = () => {
          if (window.GBS_IS_RUNNING) return;
          $(`#${item}`).click();
        };

        this[`onLoaded${item}`] = event => {
          const isProject = _.endsWith(item, "Project");

          this._cleanQueryString();

          if (isProject) this._ide().isLoading = true;
          this.loaders[item].read(this._context(), event, () => {
            if (isProject) this._ide().isLoading = false;
            else this._closePanel();
          });
        };
      });
    },

    newProject: function() {
      if (window.GBS_IS_RUNNING) return;
      if (!confirm(this.localize("new-project-confirm"))) return;

      this._cleanQueryString();

      const context = this._context();
      context.ide.setModal("");
      context.setProjectName(this.localize("new-project"));
      context.editor.reset();
      context.boards.reset();
    },

    _closePanel: function() {
      $("paper-drawer-panel")[0].togglePanel();
    },

    _context: function() {
      const query = (id) => document.querySelector(id);
      const toolbar = query("#toolbar");

      return {
        ide: this._ide(),
        toolbar: toolbar,
        editor: query("#editor"),
        boards: query("#boards"),
        getProjectName: () => toolbar.projectName,
        setProjectName: (name) => toolbar.projectName = name
      };
    },

    _ide: function() {
      return document.querySelector("#gobstones-ide");
    },

    _cleanQueryString: function() {
      const queryStringStart = location.href.indexOf("?");
      const hashStart = location.href.indexOf("/#/");

      const domain = location.href.substring(
        0,
        hashStart > -1 ? hashStart : location.href.length
      );

      const newPath = location.href.substring(
        0,
        queryStringStart > -1 ? queryStringStart : location.href.length
      ).replace(domain, "");

      history.replaceState({}, '', newPath);
    }
  };
</script>
