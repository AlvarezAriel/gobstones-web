<link rel="import" href="../../scripts/parser.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">

<dom-module id="code-runner">
  <style>
    .speed-slider {
      width: 80px;
      transform: translateX(-14px);

      --paper-slider-knob-start-color: var(--google-blue-700);
      --paper-slider-knob-start-border-color: var(--google-blue-700);
      --paper-slider-pin-start-color: var(--google-blue-700);
    }

    .toast {
      --paper-toast-background-color: rgba(11, 70, 93, 0.8);
      margin-left: 53px !important;
    }
  </style>

  <template>
    <paper-toast class="toast" id="toast"></paper-toast>
    <paper-fab id="playButton"
               style="z-index: 10;"
               icon="av:play-arrow"
               title="{{localize('execute')}}"
               on-click="onButtonClick"
    ></paper-fab>
    <paper-slider style="z-index: 10" class="speed-slider" snaps min="1" max="4" max-markers="4" step="1" value="{{speed}}"></paper-slider>
  </template>

  <script>
    Polymer({
      is: 'code-runner',
      behaviors: [
        Polymer.LocalizationBehavior
      ],
      properties: {
        isRunning: {
          type: Boolean,
          value: false,
          observer: "_update"
        },
        speed: {
          type: Number,
          value: 4
        },
        throttle: {
          type: Number,
          value: 0
        }
      },
      listeners: {
        "value-change": "_onSpeedChange"
      },

      ready: function() {
        this.SPEED_MULTIPLIER = 300

        this.parser = new Parser();
        this.handles = [];
      },

      run: function({ initialState, sourceCode, options }, onSuccess, onError) {
        const ast = this.parse(sourceCode, (e) => onError(e));
        if (ast.error) return this.isRunning = false;
        const states = this._interpret(ast, initialState, options);

        if (this.throttle === 0) {
          onSuccess(_.last(states));
          return this.stop("end");
        }

        this.handles = states.map((state, i) =>
          setTimeout(() => {
            onSuccess(state);
            if (i === states.length - 1) this.stop("end");
          }, i * this.throttle)
        );
      },

      requestRun: function() {
        this.clear();
        this.isRunning = true;
        this.fire("run");
      },

      stop: function(eventToFire = "cancel") {
        this.clear();
        this.isRunning = false;
        this.fire(eventToFire);
      },

      clear: function() {
        this.handles.forEach(clearInterval);
        this.handles = [];
      },

      onButtonClick: function() {
        this.isRunning = !this.isRunning;
        if (this.isRunning) this.requestRun()
        else this.stop();
      },

      parse: function(sourceCode, onError = () => {}) {
        try {
          return this.parser.parse(sourceCode);
        } catch (e) {
          onError(e);
          return e;
        }
      },

      _interpret: function(ast, initialState, options) {
        try {
          var context = this.parser.interpret(ast, initialState);
          return this._getStates(context, context.board());
        } catch (e) {
          e.options = options;
          return this._getStates(e.context, { error: e });
        }
      },

      _getStates: function(context, lastState) {
        return context.board().snapshots.concat(lastState);
      },

      _onSpeedChange: function() {
        this.$.toast.text = this.localize(`speed-${this.speed}`);
        this.$.toast.opened = true;
        this.$.toast.center();
        this.throttle = -(this.speed - 4) * this.SPEED_MULTIPLIER;
      },

      _update: function() {
        this.$.playButton.icon = this.isRunning ? "av:stop" : "av:play-arrow";
        window.IS_RUNNING = this.isRunning;
      }
    });
  </script>
</dom-module>
