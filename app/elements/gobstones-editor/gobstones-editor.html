<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/ace-widget/ace-widget.html">

<dom-module id="gobstones-editor">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      ace-widget {
        height: 100%;
        --ace-widget-editor:{
          height: 100% !important;
          @apply(--gobstones-editor);
        }
      }
    </style>

      <ace-widget
        id="ace"
        mode="ace/mode/gobstones"
        theme="ace/theme/chrome"
        tab-size="4"
      >
      </ace-widget>
    <paper-fab icon="av:play-arrow"
               style="position:absolute; bottom: 30px; right:24px"
               on-click="onRunCode"
    ></paper-fab>
  </template>
  <script src="https://npmcdn.com/gs-weblang-core@0.1.4/umd/index.umd.min.js"
          type="text/javascript"
          charset="utf-8"></script> <!-- // TODO: Mover -->
  <script>
    Polymer({
      is: 'gobstones-editor',
      listeners: {
        "ace.editor-ready": "onAceReady",
        "ace.editor-content": "onContentChange"
      },

      onAceReady: function() {
        const editor = this.$.ace.editor;
        editor.$blockScrolling = Infinity;
      },

      onContentChange: function(content) {
        const value = content.detail.value;
      },

      onRunCode: function() {
        const editor = this.$.ace.editor;
        const sourceCode = this.$.ace.editor.getValue();

        editor.getSession().clearAnnotations();

        try {
          const context = this._parse(sourceCode);
          this.fire("execution-result", { context: context });
        } catch (e) {
          console.log("CATCHED PARSER ERROR: ", e);
          editor.getSession().setAnnotations([{
            row: e.on.row,
            column: 0,
            text: e.error,
            type: "error" // also warning and information
          }]);
        }
      },

      _parse: function(sourceCode) {
        const {
          tokens, interpreter, lexer: Lexer,
          parser: Parser, grammar: Grammar,
          context: Context
        } = window.gsWeblangCore;

        const context = this._createContext(Context);
        const grammar = Grammar(Parser, new Lexer(), tokens, interpreter);
        const ast = grammar.parseProgram(sourceCode);

        try {
          grammar.interpret(ast, context);
        } catch (e) {
          console.log("INTERPRETER ERROR: ", e);
        }

        return context;
      },

      _createContext: function(Context) {
        const context = new Context();
        context.board().sizeX = 2; // TODO: Unharcode here and in weblang-core
        context.board().sizeY = 2;
        context.init();
        return context;
      }
    });
  </script>
</dom-module>
