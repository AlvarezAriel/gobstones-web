<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/gs-board/dist/components/gs-board.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/expressionBehavior.html">
<link rel="import" href="../../scripts/behaviors/toastBehavior.html">
<link rel="import" href="../../scripts/parserAndBoardAdapter.html">
<link rel="import" href="../../scripts/stylist.html">

<dom-module id="boards-panel">
  <template>

    <style>
      .boards-panel {
        text-align: center;
      }

      .show-code-icon {
        margin-left: -5px;
        margin-right: 10px;
      }

      .wind-rose {
        margin-top: 3px;
        margin-left: 10px;
        width: 55px;
        height: 55px;
      }

      .alert {
        color: red;
      }

      .toast {
        --paper-toast-background-color: rgba(255, 0, 0, 0.8);
        margin-left: 40% !important;
      }

      .gray {
        color: gray;
      }

      .hidden {
        visibility: hidden;
      }

      .tabs {
        margin-left: -10px;
        margin-right: -10px;
        margin-top: -10px;
        border-left: solid 1px;
        border-color: #688998;

        z-index: 10;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .size-bar {
        margin-top: -22px;
        margin-bottom: 5px;
        overflow: hidden;
        white-space: nowrap;
      }

      .size-container {
        display: inline;
      }

      .attire-container {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .size-input {
        display: inline-block;
        width: 50px;
      }

      .boom-container {
        margin-top: 10px;
      }

      .theBoardContainer {
        margin-left: -8px;
      }

      .clear-button {
        position: absolute;
        margin-left: 28px;
        margin-top: 2px;
      }

      .boards-button {
        position: absolute;
        margin-left: -16px;
        margin-top: -13px;
      }

      paper-tab {
        --paper-tab-content-unselected: {
          opacity: 0.5;
        }
      }
    </style>

    <paper-toolbar class="tabs">
      <div>
        <paper-button on-click="toggleShowCode"><iron-icon class="button show-code-icon" icon="icons:chevron-{{_showCodeDirection(showCode)}}"></iron-icon></paper-button>
      </div>
      <div style="width: 90%">
        <paper-tabs no-bar selected="{{selectedTab}}" class="bottom self-end">
          <paper-tab>[[localize("initial-board")]] [[toOneBased(selectedInitialState)]]</paper-tab>
          <template is="dom-if" if="{{isFinalBoardVisible(finalState, error)}}">
            <paper-tab>[[localize("final-board")]]</paper-tab>
          </template>
        </paper-tabs>
      </div>
      <div>
        <img class="wind-rose" src="../../images/wind-rose.png" />
      </div>
    </paper-toolbar>

    <paper-toast class="toast" id="toast"></paper-toast>

    <paper-button class="clear-button" on-click="cleanBoards"><iron-icon class$="{{clearButtonCss(selectedTab, showAttire)}}" icon="icons:delete-forever"></iron-icon></paper-button>

    <div class="boards-button">
      <paper-menu-button class$="{{boardButtonCss(selectedTab, showAttire)}}">
        <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
        <paper-menu class="dropdown-content" selected="{{ selectedInitialState }}">
          <template is="dom-repeat" items="{{ availableInitialStates }}">
            <paper-item>[[localize("initial-board")]] [[toOneBased(index)]]</paper-item>
          </template>
        </paper-menu>
      </paper-menu-button>
    </div>

    <div class="boards-panel">
      <div class="size-bar">
        <div class$="{{boardSizeCss(selectedTab, showAttire)}}">
          <form>
            <div class="size-container">
              <strong>[[localize("size")]]:</strong>
              <paper-input class="size-input" value="{{sizeX}}" type="number" min="1" max="30" disabled$="{{isInitialBoardNotEditable(selectedTab, showAttire)}}"></paper-input>
            </div>
            <div class="size-container">
              <span>[[localize("columns")]] <strong>[[localize("by")]]</strong></span>
              <paper-input class="size-input" value="{{sizeY}}" type="number" min="1" max="30" disabled$="{{isInitialBoardNotEditable(selectedTab, showAttire)}}"></paper-input>
              <span>[[localize("rows")]]</span>
            </div>
          </form>
        </div>
      </div>

      <div class="attire-container">
        <paper-button on-click="toggleShowAttire"><iron-icon class="black-button" icon="icons:visibility"></iron-icon></paper-button>
        <strong>[[localize("attire")]]:</strong>
        <paper-dropdown-menu no-animations no-label-float vertical-align="bottom" horizontal-align="right" disabled="{{!showAttire}}">
          <paper-listbox class="dropdown-content" selected="{{selectedAttire}}">
            <template is="dom-repeat" items="{{ availableAttires }}">
              <paper-item>{{item.name}}</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>

      <div class="theBoardContainer" style="position: relative;">
        <div class="theBoard" style="position: absolute; left: 0; right: 0;">
          <!-- Initial board -->
          <template is="dom-if" if="{{isInitialBoardSelected(selectedTab)}}">
            <gs-board id="initialStateEditor" table="{{initialState.table}}" header="{{initialState.header}}" size="{{size}}" options='{{initialBoardOptions}}' attire="{{attire}}"></gs-board>
          </template>

          <!-- Final board -->
          <template is="dom-if" if="{{isFinalBoardSelected(selectedTab)}}">
            <template is="dom-if" if="{{!error}}">
              <template is="dom-if" if="{{finalState}}" restamp="true">
                <gs-board table="{{finalState.table}}" header="{{finalState.header}}" attire="{{attire}}"></gs-board>
              </template>
            </template>
          </template>
        </div>
      </div>

      <template is="dom-if" if="{{isFinalBoardSelected(selectedTab)}}">
        <template is="dom-if" if="{{error}}">
          <div class="boom-container">
            <img src="../../images/boom.png" />
            <h2>[[localize("boom")]]</h2>
            <div class="alert">{{error}}</div>
          </div>
        </template>
      </template>
    </div>

  </template>

  <script>

    Polymer({
      is: 'boards-panel',
      behaviors: [
        Polymer.LocalizationBehavior,
        Polymer.ExpressionBehavior,
        Polymer.ToastBehavior
      ],
      properties: {
        showCode: {
          type: Boolean,
          value: true
        },
        selectedTab: {
          type: Number,
          value: 0,
          observer: "_protectSelectedTab"
        },
        sizeX: {
          type: Number,
          value: 4,
          observer: "_updateSize"
        },
        sizeY: {
          type: Number,
          value: 4,
          observer: "_updateSize"
        },
        size: {
          type: Object,
          computed: "_computeSize(sizeX, sizeY)",
          observer: "_updateSize"
        },
        initialBoardOptions: {
          type: Object,
          computed: "_computeInitialBoardOptions(showAttire)"
        },

        finalState: Object,
        error: Object,

        availableInitialStates: {
          type: Array,
          value: []
        },
        initialState: {
          type: Object,
          computed: "_computeInitialState(selectedInitialState)",
          observer: "_onBoardSelected"
        },
        selectedInitialState: {
          type: Number,
          value: 0
        },

        availableAttires: {
          type: Array,
          value: []
        },
        attire: {
          type: Object,
          computed: "_computeAttire(selectedAttire, showAttire)"
        },
        selectedAttire: {
          type: Number,
          value: 0
        },
        showAttire: {
          type: Boolean,
          value: false,
          observer: "_updateAttire"
        }
      },
      listeners: {
        "board-changed": "_onBoardChanged"
      },

      ready: function() {
        this.stylist = new Stylist();
        this.stylist.setPanelAsResizable(this.size);

        this._adapter = new ParserAndBoardAdapter();

        this._subscribeToEditor("run-request", () => {
          this._onRunRequest();
        })._subscribeToEditor("cancel-request", () => {
          this._cleanState();
        })._subscribeToEditor("execution-result", (eventInfo) => {
          this._onResult(eventInfo);
        })._subscribeToEditor("compilation-error", (eventInfo) => {
          this._onCompilationError(eventInfo);
        })._subscribeToEditor("execution-error", (eventInfo) => {
          this._onExecutionError(eventInfo);
        })._subscribeToEditor("unknown-error", (eventInfo) => {
          this._onUnknownError(eventInfo);
        })._subscribeToEditor("editor-dirty", () => {
          this._cleanState();
        });

        if (this.availableInitialStates.length > 0) return;
        this._bootstrap();
      },

      toggleShowCode: function() {
        this.showCode = !this.showCode;
        this.fire("show-code-changed", this.showCode);
      },

      toggleShowAttire: function() {
        if (this.availableAttires.length === 0) return;
        this.showAttire = !this.showAttire;
      },

      buttonCssClass: function(element) {
        if (!this.domHost) return;
        return this.domHost.buttonCssClass(element);
      },

      isInitialBoardSelected: (selectedTab) => selectedTab === 0,
      isFinalBoardSelected: (selectedTab) => selectedTab === 1,
      isFinalBoardVisible: (finalState, error) => finalState || error,
      isInitialBoardNotEditable: (selectedTab, showAttire) => selectedTab === 1 || showAttire,

      addOrSetAttire: function(attire) {
        var availableAttire = _.find(this.availableAttires, { name: attire.name });

        if (!availableAttire) {
          this.push("availableAttires", attire);
          this.selectedAttire = this.availableAttires.length - 1;
        } else
          this.selectedAttire = this.availableAttires.indexOf(availableAttire);
      },

      addInitialState: function(initialState) {
        this.push("availableInitialStates", initialState);
        this.selectedInitialState = this.availableInitialStates.length - 1;
      },

      reset: function() {
        this.sizeX = 4;
        this.sizeY = 4;

        this.availableInitialStates = [];
        this.availableAttires = [];

        this._bootstrap();
        this._cleanState();
        this.selectedInitialState = 0;
        this.selectedAttire = 0;
        this.showAttire = false;
      },

      cleanBoards: function() {
        this.sizeX = 4;
        this.sizeY = 4;

        this.set("initialState.header", { x: 0, y: 0 });
        this.set("initialState.table", this._buildEmptyTable(this.sizeX, this.sizeY));

        this._cleanState();
      },

      _bootstrap: function() {
        this.addInitialState({
          header: { x: 0, y: 0 },
          table: this._buildEmptyTable(this.sizeX, this.sizeY)
        });
      },

      _buildEmptyTable: function(sizeX, sizeY) {
        return _.range(sizeY).map(row => {
          return _.range(sizeX).map(cell => {
            return {};
          });
        });
      },

      _onRunRequest: function() {
        this._cleanState();

        const initialStateEditor = this.$$("#initialStateEditor");
        const initialState = {
          header: initialStateEditor.header,
          table: this._adapter.adaptToParser(initialStateEditor.table),
          size: initialStateEditor.size
        }
        this.fire("initial-state", initialState);
      },

      _onResult: function(result) {
        const board = result.board;

        this._setFinalState({
          header: _.pick(board, "x", "y"),
          table: this._adapter.adaptToBoard(board.table)
        });
      },

      _onCompilationError: function(error) {
        this.showToast(this.localize("the-program-has-errors"));
      },

      _onExecutionError: function(error) {
        this.error = error;
        this.selectedTab = 1;
      },

      _onUnknownError: function(error) {
        this.showToast(this.localize("unknown-interpreter-error"));
      },

      _setFinalState: function(finalState) {
        this.finalState = null;
        this.async(function() {
          this.finalState = finalState;
          this.selectedTab = 1;
        });
      },

      _onBoardChanged: function() {
        const initialStateEditor = this.$$("#initialStateEditor");
        const initialState = this.availableInitialStates[this.selectedInitialState];
        // ^ Use this and not `this.initialState`! The listeners execute before computed properties.

        // TODO: Lo siguiente.
        /*
        - el header está desfasado
        - botones + y -
        - persistir en proyecto
        - al cargar proyecto, borrar el default bootstrappeado
        */

        console.log("EL NUEVO HEADER ES", initialStateEditor.header);
        initialState.header = initialStateEditor.header;
        initialState.table = initialStateEditor.table;

        this._cleanState();
      },

      _onBoardSelected: function() {
        const size = this._getSizeOf(this.initialState.table);

        this.sizeX = size.x;
        this.sizeY = size.y;
      },

      _cleanState: function() {
        this.finalState = null;
        this.error = null;
        this.selectedTab = 0;
      },

      _subscribeToEditor: function(eventName, eventHandler) {
        const handler = (event) => eventHandler(event.detail);
        this.async(() => {
          document.querySelector("#editor").addEventListener(eventName, handler);
        });
        return this;
      },

      _showCodeDirection: function(value) {
        return value ? 'left' : 'right';
      },

      _computeSize: function(sizeX, sizeY) {
        const x = sizeX === "" ? this.size.x : this._limitSize(sizeX);
        const y = sizeY === "" ? this.size.y : this._limitSize(sizeY);
        if (sizeX !== "") this.sizeX = x;
        if (sizeY !== "") this.sizeY = y;

        return { x: x, y: y };
      },

      _computeAttire: function(selectedAttire, showAttire) {
        var attire = this.availableAttires[selectedAttire];
        if (attire) attire.enabled = showAttire;
        return attire;
      },

      _computeInitialState: function(selectedInitialState) {
        return this.availableInitialStates[selectedInitialState];
      },

      _computeInitialBoardOptions: function(showAttire) {
        return { editable: !showAttire };
      },

      _limitSize: function(n) {
        return Math.max(Math.min(n, 30), 1);
      },

      _updateSize: function() {
        if (this.stylist) this.stylist.updateBoardSize(this.size);
      },

      _updateAttire: function() {
        this.set("attire.enabled", this.showAttire);
      },

      _protectSelectedTab: function() {
        if (IS_RUNNING) this.selectedTab = 1;
      },

      _getSizeOf: function(table) {
        return { x: table[0].length, y: table.length };
      },

      boardSizeCss: function(selectedTab, showAttire) {
        return this.isInitialBoardNotEditable(selectedTab, showAttire) ? "gray" : "";
      },

      clearButtonCss: function(selectedTab, showAttire) {
        return this.boardButtonCss(selectedTab, showAttire, "black-button");
      },

      boardButtonCss: function(selectedTab, showAttire, extra = "") {
        return extra + (this.isInitialBoardNotEditable(selectedTab, showAttire) ? " hidden" : "");
      }
    });

  </script>
</dom-module>
