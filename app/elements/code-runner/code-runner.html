<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../scripts/parser.html">
<link rel="import" href="../../scripts/runners/normalRunner.html">
<link rel="import" href="../../scripts/runners/interactiveRunner.html">
<link rel="import" href="../../scripts/behaviors/busListenerBehavior.html">
<link rel="import" href="../../scripts/behaviors/localizationBehavior.html">
<link rel="import" href="../../scripts/behaviors/toastBehavior.html">

<dom-module id="code-runner">
  <style>
    .random-toggle {
      position: absolute;
      cursor: pointer;
      left: 49px;
      top: 43px;
    }

    .speed-slider {
      width: 80px;
      transform: translateX(-14px);

      --paper-slider-knob-start-color: var(--google-blue-700);
      --paper-slider-knob-start-border-color: var(--google-blue-700);
      --paper-slider-pin-start-color: var(--google-blue-700);
    }

    .toast {
      --paper-toast-background-color: rgba(11, 70, 93, 0.8);
      margin-left: 53px !important;
    }
  </style>

  <template>
    <paper-toast class="toast" id="toast"></paper-toast>
    <paper-fab id="playButton"
               style="z-index: 10;"
               icon="av:play-arrow"
               title="{{localize('execute')}}"
               on-click="onButtonClick"
    ></paper-fab>
    <template is="dom-if" if="{{permissions.can_change_source}}">
      <paper-button class="random-toggle" on-click="toggleRandom"><iron-icon class$="{{toggleRandomCss(useRandomBoard)}}" icon="av:shuffle"></iron-icon></paper-button>
    </template>
    <paper-slider id="speedSlider" style="z-index: 10" class="speed-slider" snaps min="1" max="4" max-markers="4" step="1" value="{{speed}}" immediate-value="{{immediateSpeed}}" value="4", disabled="{{!permissions.can_change_speed}}"></paper-slider>
  </template>

  <script>
    Polymer({
      is: 'code-runner',
      behaviors: [
        Polymer.BusListenerBehavior,
        Polymer.LocalizationBehavior,
        Polymer.ToastBehavior
      ],
      properties: {
        isRunning: {
          type: Boolean,
          value: false,
          observer: "_update"
        },
        speed: {
          type: Number,
          value: 4
        },
        useRandomBoard: {
          type: Boolean,
          value: false
        },

        throttle: {
          type: Number,
          computed: "_computeThrottle(speed)"
        },
        immediateSpeed: {
          type: Number,
          value: 4
        },

        permissions: {
          type: Object,
          value: {
            can_change_source: true,
            can_change_speed: true
          }
        }
      },
      listeners: {
        "immediate-value-change": "_onSpeedChange"
      },

      ready: function() {
        this.parser = new Parser();
        this.runner = new NormalRunner(this.parser);
        this.subscribeTo("reset", () => this.reset());
      },

      run: function(request, onCompilationError, onResult) {
        this.isRunning = true;

        const code = request.code;
        const itBroke = (err, code) => {
          this.stop();
          onCompilationError(err, code);
        };

        try {
          this._checkAndGetTeacherAst(code, itBroke, teacherAst => {
            this._parse(code, itBroke, ast => {
              this._setRunner(ast);
              if (!ast.program) {
                const error = new Error(this.localize("missing-program"));
                error.location = { mode: "code", line: 1 };
                itBroke(error);
                return;
              }

              this.runner.run({
                ast: {
                  program: ast.program,
                  teacher: teacherAst
                },
                request: request,
                throttle: this.throttle,
                callbacks: {
                  onResult: onResult,
                  onStop: (eventToFire) => this.stop(eventToFire)
                }
              });
            }, true);
          });
        } catch (e) {
          this.stop();
          throw e;
        }
      },

      requestRun: function() {
        this._clear();
        this.fire("run", { useRandomBoard: this.useRandomBoard });
      },

      stop: function(eventToFire = "cancel") {
        window.BUS.fire("execution-stop");
        this._clear();
        this.isRunning = false;
        this.async(() => {
          this.fire(eventToFire);
        });
      },

      onButtonClick: function() {
        this.isRunning = !this.isRunning;
        if (this.isRunning) this.requestRun()
        else this.stop();
      },

      toggleRandom: function() {
        this.useRandomBoard = !this.useRandomBoard;
        this.showToast(this.localize(`using-random-${this.useRandomBoard}`));
      },

      reset: function() {
        this.speed = 4;
        this.useRandomBoard = false;

        this.set("permissions.can_change_source", true);
        this.set("permissions.can_change_speed", true);
      },

      reportTeacherLibraryErrors: function(e) {
        alert("The teacher's library has errors. See the developer console.");
        throw e;
      },

      _setRunner: function(ast) {
        this.runner = this._isInteractive(ast)
          ? new InteractiveRunner(this.parser)
          : new NormalRunner(this.parser);
      },

      _clear: function() {
        this.runner.clear();
      },

      _checkAndGetTeacherAst: function(code, onError, onSuccess) {
        this._checkLibraryCompiles(code.library, onError, () => {
          return this._checkLibraryCompiles(
            code.teacher,
            this.reportTeacherLibraryErrors,
            onSuccess
          );
        });
      },

      _checkLibraryCompiles: function(sourceCode, onError, onSuccess) {
        this._parse({ library: sourceCode, main: "", teacher: "" }, onError, onSuccess);
      },

      _parse: function(code, onError, onSuccess, fixMainErrorLines) {
        const sourceCode = code.library + "\n" + code.main + "\n" + code.teacher;

        this.parser.parse(sourceCode, e => {
          e.location = this.parser.getErrorLineAndMode(e, code, fixMainErrorLines);
          return onError(e, code);
        }, onSuccess);
      },

      _isInteractive: function(ast) {
        return ast && ast.program && ast.program.alias === "interactiveProgram";
      },

      _onSpeedChange: function() {
        this.showToast(this.localize(`speed-${this.immediateSpeed}`));
      },

      _computeThrottle: function(speed) {
        return -(this.speed - 4) * 300;
      },

      _update: function() {
        this.$.playButton.icon = this.isRunning ? "av:stop" : "av:play-arrow";
        window.GBS_IS_RUNNING = this.isRunning;
      },

      toggleRandomCss: function(useRandomBoard) {
        return useRandomBoard ? "blue-sky" : "gray"
      }
    });
  </script>
</dom-module>
